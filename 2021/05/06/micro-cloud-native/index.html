<!DOCTYPE html>


<html lang="zh-CN">


<head>

  <meta name="360-site-verification" content="f9d6085a601adc10d072166e30db1c3e" />

  <meta http-equiv="Content-Type" content="text/html;
charset=gb2312"/>
  <meta name="sogou_site_verification" content="SgemPigfrE"/>

   
  <meta name="keywords" content="java,key, key1, key2, key3" />
   
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title style="color: blue; font-style: oblique">
    Damon | Micro-Service | Containerization | DevOps
  </title>
  <meta name="generator" content="hexo-theme-ayer">

  
  <link rel="shortcut icon" href="/images/logo/logo.png" />
  

  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  

  <script>
      (function(){
          var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
          document.write('<script src="' + src + '" id="sozz"><\/script>');
      })();
  </script>


  <!--<script data-ad-client="ca-pub-1354758384344627" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js">
  Owner Damon | Micro-Service | Containerization | DevOps
  Damon | Micro-Service | Containerization | DevOps
  Damon | ΢���� | ������ | �Զ���
  Damon | Micro-Service | Containerization | DevOps
  </script>-->

  

  


  <!--<script async custom-element="amp-auto-ads"
          src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
  </script>-->
<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

</html>

<body>

<script>
    (function(){
        var src = "https://s.ssl.qhres2.com/ssl/ab77b6ea7f3fbf79.js";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
    })();
</script>

    <!--<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    &lt;!&ndash; Unit one &ndash;&gt;
    <ins class="adsbygoogle"
         style="display:inline-block;width:400px;height:90px"
         data-ad-client="ca-pub-1354758384344627"
         data-ad-slot="8964778819"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->

  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-micro-cloud-native"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  云原生微服务架构实践
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2021/05/06/micro-cloud-native/" class="article-date">
  <time datetime="2021-05-06T12:58:51.000Z" itemprop="datePublished">2021-05-06</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">31.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长约</span>
            <span class="post-count">136 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="写作本书的目的"><a href="#写作本书的目的" class="headerlink" title="写作本书的目的"></a><strong>写作本书的目的</strong></h4><p>&emsp;&emsp;微服务架构已经火了很多年了，如：Dubbo、Spring Cloud，再到后来的 Spring Cloud Alibaba，但都是仅限于 Java 语言的瓶颈，如何让各种语言之间的微服务更加有效、快速的通讯，这是当前很多企业需要面临的问题，因为一个企业中，不只是基于单纯的某一种语言开发，这就涉及到多语言服务之间的访问。本书的创作重点，则是在于讲述在巨多语言的情况下，该如何设计微服务架构，以及云原生时代的微服务的高可用、自动化等等。</p>
<h4 id="如何阅读本书"><a href="#如何阅读本书" class="headerlink" title="如何阅读本书"></a><strong>如何阅读本书</strong></h4><p>&emsp;&emsp;由于本书介绍的一些知识都是比较流行的，最近几年很火的，而且本身其涉及的面还是很广的：<strong>K8s</strong>，大家可以通过其<a href="https://kubernetes.io/" target="_blank" rel="noopener">官网</a>系统的学习其相关技术与实践，以便可以更好的将其发挥于微服务架构设计中。另外，本书中介绍的知识，大家都可以一边实践、一边阅读，以便更深刻的理解其原理。</p>
<h4 id="扫码关注作者"><a href="#扫码关注作者" class="headerlink" title="扫码关注作者"></a><strong>扫码关注作者</strong></h4><ul>
<li><p>作者毕业于三流院校，笔名：Damon，拥有七年工作经验，技术爱好者，长期从事 Java 开发、Spring Cloud、Golang 的微服务架构设计，以及结合 Docker、K8s 做微服务容器化，自动化部署等一站式项目落地。目前主要从事基于 K8s 云原生架构研发的工作。Golang 语言开发，长期研究边缘计算框架 KubeEdge、调度框架 Volcano 等。公众号：<strong>程序猿Damon</strong>，个站：<strong><a href="http://www.damon8.cn">www.damon8.cn</a></strong>。</p>
</li>
<li><p>欢迎扫码回复「入群」加入技术交流群</p>
</li>
</ul>
<p><img src="https://static001.geekbang.org/infoq/38/385163791aa296c4cc23be10afa5631d.jpeg" alt=""></p>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><h4 id="第一部分-基础知识"><a href="#第一部分-基础知识" class="headerlink" title="第一部分 基础知识"></a>第一部分 基础知识</h4><h5 id="第一章-什么是微服务架构"><a href="#第一章-什么是微服务架构" class="headerlink" title="第一章 什么是微服务架构"></a>第一章 什么是微服务架构</h5><h6 id="1-1-微服务到底是啥"><a href="#1-1-微服务到底是啥" class="headerlink" title="1.1 微服务到底是啥"></a>1.1 微服务到底是啥</h6><h6 id="1-2-微服务的发展史"><a href="#1-2-微服务的发展史" class="headerlink" title="1.2 微服务的发展史"></a>1.2 微服务的发展史</h6><h6 id="1-3-微服务的革命性与重要性"><a href="#1-3-微服务的革命性与重要性" class="headerlink" title="1.3 微服务的革命性与重要性"></a>1.3 微服务的革命性与重要性</h6><h5 id="第二章-微服务的拆分"><a href="#第二章-微服务的拆分" class="headerlink" title="第二章 微服务的拆分"></a>第二章 微服务的拆分</h5><h6 id="2-1-微服务的设计原则"><a href="#2-1-微服务的设计原则" class="headerlink" title="2.1 微服务的设计原则"></a>2.1 微服务的设计原则</h6><h6 id="2-2-微服务划分的粒度"><a href="#2-2-微服务划分的粒度" class="headerlink" title="2.2 微服务划分的粒度"></a>2.2 微服务划分的粒度</h6><h6 id="2-3-不同场景的微服务"><a href="#2-3-不同场景的微服务" class="headerlink" title="2.3 不同场景的微服务"></a>2.3 不同场景的微服务</h6><h5 id="第三章-容器化技术"><a href="#第三章-容器化技术" class="headerlink" title="第三章 容器化技术"></a>第三章 容器化技术</h5><h6 id="3-1-什么是容器"><a href="#3-1-什么是容器" class="headerlink" title="3.1 什么是容器"></a>3.1 什么是容器</h6><h6 id="3-2-容器的发展进程"><a href="#3-2-容器的发展进程" class="headerlink" title="3.2 容器的发展进程"></a>3.2 容器的发展进程</h6><h6 id="3-3-Docker-与-Kubernetes"><a href="#3-3-Docker-与-Kubernetes" class="headerlink" title="3.3 Docker 与 Kubernetes"></a>3.3 Docker 与 Kubernetes</h6><h6 id="3-4-K8s-容器化应用"><a href="#3-4-K8s-容器化应用" class="headerlink" title="3.4 K8s 容器化应用"></a>3.4 K8s 容器化应用</h6><h5 id="第四章-为何借助容器助力微服务"><a href="#第四章-为何借助容器助力微服务" class="headerlink" title="第四章 为何借助容器助力微服务"></a>第四章 为何借助容器助力微服务</h5><h6 id="4-1-微服务的多语言性"><a href="#4-1-微服务的多语言性" class="headerlink" title="4.1 微服务的多语言性"></a>4.1 微服务的多语言性</h6><h6 id="4-2-微服务的高可用"><a href="#4-2-微服务的高可用" class="headerlink" title="4.2 微服务的高可用"></a>4.2 微服务的高可用</h6><h6 id="4-3-微服务的复杂性"><a href="#4-3-微服务的复杂性" class="headerlink" title="4.3 微服务的复杂性"></a>4.3 微服务的复杂性</h6><h4 id="第二部分-原理与应用"><a href="#第二部分-原理与应用" class="headerlink" title="第二部分 原理与应用"></a>第二部分 原理与应用</h4><h5 id="第五章-Kubernetes-介绍"><a href="#第五章-Kubernetes-介绍" class="headerlink" title="第五章 Kubernetes 介绍"></a>第五章 Kubernetes 介绍</h5><h6 id="5-1-Kubernetes-的基本概念与特性"><a href="#5-1-Kubernetes-的基本概念与特性" class="headerlink" title="5.1 Kubernetes 的基本概念与特性"></a>5.1 Kubernetes 的基本概念与特性</h6><h6 id="5-2-部署-Kubernetes-集群"><a href="#5-2-部署-Kubernetes-集群" class="headerlink" title="5.2 部署 Kubernetes 集群"></a>5.2 部署 Kubernetes 集群</h6><h6 id="5-3-Kubernetes-的组件及及负载均衡"><a href="#5-3-Kubernetes-的组件及及负载均衡" class="headerlink" title="5.3 Kubernetes 的组件及及负载均衡"></a>5.3 Kubernetes 的组件及及负载均衡</h6><h5 id="第六章-为什么选择-Kubernetes"><a href="#第六章-为什么选择-Kubernetes" class="headerlink" title="第六章 为什么选择 Kubernetes"></a>第六章 为什么选择 Kubernetes</h5><h6 id="6-1-Kubernetes-与微服务的天生绝配"><a href="#6-1-Kubernetes-与微服务的天生绝配" class="headerlink" title="6.1 Kubernetes 与微服务的天生绝配"></a>6.1 Kubernetes 与微服务的天生绝配</h6><h6 id="6-2-基于-Kubernetes-集群的服务治理"><a href="#6-2-基于-Kubernetes-集群的服务治理" class="headerlink" title="6.2 基于 Kubernetes 集群的服务治理"></a>6.2 基于 Kubernetes 集群的服务治理</h6><h6 id="6-3-基于-Kubernetes-的服务无缝迁移"><a href="#6-3-基于-Kubernetes-的服务无缝迁移" class="headerlink" title="6.3 基于 Kubernetes 的服务无缝迁移"></a>6.3 基于 Kubernetes 的服务无缝迁移</h6><h5 id="第七章-第一个基于-K8s-的多语言微服务架构"><a href="#第七章-第一个基于-K8s-的多语言微服务架构" class="headerlink" title="第七章 第一个基于 K8s 的多语言微服务架构"></a>第七章 第一个基于 K8s 的多语言微服务架构</h5><h6 id="7-1-基于-K8s-的-Java-微服务"><a href="#7-1-基于-K8s-的-Java-微服务" class="headerlink" title="7.1 基于 K8s 的 Java 微服务"></a>7.1 基于 K8s 的 Java 微服务</h6><h6 id="7-2-第一个Golang微服务"><a href="#7-2-第一个Golang微服务" class="headerlink" title="7.2 第一个Golang微服务"></a>7.2 第一个Golang微服务</h6><h6 id="7-3-部署微服务应用"><a href="#7-3-部署微服务应用" class="headerlink" title="7.3 部署微服务应用"></a>7.3 部署微服务应用</h6><br/>
<br/>
<br/>
<br/>

<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="第一部分-基础知识-1"><a href="#第一部分-基础知识-1" class="headerlink" title="第一部分 基础知识"></a>第一部分 基础知识</h4><h5 id="第一章-什么是微服务架构-1"><a href="#第一章-什么是微服务架构-1" class="headerlink" title="第一章 什么是微服务架构"></a>第一章 什么是微服务架构</h5><h6 id="1-1-微服务的发展史"><a href="#1-1-微服务的发展史" class="headerlink" title="1.1 微服务的发展史"></a>1.1 微服务的发展史</h6><p>&emsp;&emsp;在微服务到来之前，单体应用程序所暴露的缺点主要有：</p>
<ul>
<li>复杂性高</li>
<li>团队协作开发成本高</li>
<li>扩展性差</li>
<li>部署效率低下</li>
<li>系统很差的高可用性</li>
</ul>
<p>&emsp;&emsp;复杂性，体现在：随着业务的不断迭代，项目的代码量急剧的增多，项目模块也会随着而增加，整个项目就会变成的非常复杂。</p>
<p>&emsp;&emsp;开发成本高，体现在：团队开发几十个人在修改代码，然后一起合并到同一地址分支，打包部署，测试阶段只要有一小块功能有问题，就得重新编译打包部署，重新测试，所有相关的开发人员都得参与其中，效率低下，开发成本极高。</p>
<p>&emsp;&emsp;扩展性差，体现在：在新增功能业务的时候，代码层面会考虑在不影响现有的业务基础上编写代码，提高了代码的复杂性。</p>
<p>&emsp;&emsp;部署效率低，体现在：当单体应用的代码越来越多，依赖的资源越来越多时，应用编译打包、部署测试一次，需要花费的时间越来越多，导致部署效率低下。</p>
<p>&emsp;&emsp;高可用差，体现在：由于所有的业务功能最后都部署到同一个文件，一旦某一功能涉及的代码或者资源有问题，那就会影响到整个文件包部署的功能。举个特别鲜明的示例：上世纪八、九十年代，很多的黄页以及延伸到后来的网站中，很多的展示页面与获取数据的后端都是在一个服务模块中。这就造成一个很不好的影响：如果只是修改极小部分的页面展示或图片展示，则需要把整个服务模块进行打包部署，这样会导致时间的严重浪费以及成本的增加。更加糟糕的是，给用户带来非常不好的体验，用户无法理解的是：只是换个网站的某块微小的展示区，导致了整个网站在那一时刻无法正常的访问。当然，也许，对于那个时候互联网的不发达，人们对于这样的体验，已经算是一种幸福的享受了。</p>
<p>&emsp;&emsp;由于单体应用具有以上的种种缺点，导致了一个新名词、新概念的诞生：微服务。</p>
<h6 id="1-2-微服务到底是啥"><a href="#1-2-微服务到底是啥" class="headerlink" title="1.2 微服务到底是啥"></a>1.2 微服务到底是啥</h6><p>&emsp;&emsp;其实，从早年间的单体应用，到 2014 年起，得益于以 Docker 为代表的容器化技术的成熟以及 DevOps 文化的兴起，服务化的思想进一步演化，演变为今天我们所熟知的微服务。那么，微服务到底是啥？</p>
<p>&emsp;&emsp;微服务，英文名：microservice，百度百科上将其定义为：SOA 架构的一种变体。微服务（或微服务架构）是一种将应用程序构造为一组低耦合的服务。</p>
<p>&emsp;&emsp;微服务有着一些鲜明的特点：</p>
<ul>
<li>功能单一</li>
<li>服务粒度小</li>
<li>服务间独立性强</li>
<li>服务间依赖性弱</li>
<li>服务独立维护</li>
<li>服务独立部署</li>
</ul>
<p>&emsp;&emsp;对于每一个微服务来说，其提供的功能应该是单一的；其粒度很小的；它只会提供某一业务功能涉及到的相关接口。如：电商系统中的订单系统、支付系统、产品系统等，每一个系统服务都只是做该系统独立的功能，不会涉及到不属于它的功能逻辑。</p>
<p>&emsp;&emsp;微服务之间的依赖性应该是尽量弱的，这样带来的好处是：不会因为单一系统服务的宕机，而导致其它系统无法正常运行，从而影响用户的体验。同样以电商系统为例：用户将商品加入购物车后，提交订单，这时候去支付，发现无法支付，此时，可以将订单进入待支付状态，从而防止订单的丢失和用户体验的不友好。如果订单系统与支付系统的强依赖性，会导致订单系统一直在等待支付系统的回应，这样会导致用户的界面始终处于加载状态，从而导致用户无法进行任何操作。</p>
<p>&emsp;&emsp;当出现某个微服务的功能需要升级，或某个功能需要修复 bug 时，只需要把当前的服务进行编译、部署即可，不需要一个个打包整个产品业务功能的巨多服务，独立维护、独立部署。</p>
<p>&emsp;&emsp;上面描述的微服务，其实突出其鲜明特性：<strong>高内聚、低耦合</strong>，问题来了。什么是高内聚，什么是低耦合呢？所谓高内聚：就是说每个服务处于同一个网络或网域下，而且相对于外部，整个的是一个封闭的、安全的盒子。盒子对外的接口是不变的，盒子内部各模块之间的接口也是不变的，但是各模块内部的内容可以更改。模块只对外暴露最小限度的接口，避免强依赖关系。增删一个模块，应该只会影响有依赖关系的相关模块，无关的不应该受影响。</p>
<p>&emsp;&emsp;所谓低耦合：从小的角度来看，就是要每个 Java 类之间的耦合性降低，多用接口，利用 Java 面向对象编程思想的封装、继承、多态，隐藏实现细节。从模块之间来讲，就是要每个模块之间的关系降低，减少冗余、重复、交叉的复杂度，模块功能划分尽可能单一。</p>
<h6 id="1-3-微服务的革命性与重要性-1"><a href="#1-3-微服务的革命性与重要性-1" class="headerlink" title="1.3 微服务的革命性与重要性"></a>1.3 微服务的革命性与重要性</h6><p>&emsp;&emsp;上一小节讲述了什么是微服务，微服务的鲜明特性。其实，从单体应用看微服务，就能看出微服务的重要性，它是彻底改革了应用程序的惯性，它的设计理念的出现：让开发人员减少大量的开发成本以及修复成本；让产品的使用者拥有一种舒适的体验感。它解决了单体应用程序的很多难以解决的问题，更具有创新性。它让我们的系统尽可能快地响应变化。</p>
<p>&emsp;&emsp;微服务将原来耦合在一起的复杂业务拆分为单个服务，规避了原本复杂度无止境的积累，每一个微服务专注于单一功能，并通过定义良好的接口清晰表述服务边界。</p>
<p>&emsp;&emsp;由于微服务具备独立的运行进程，所以每个微服务可以独立部署。当业务迭代时只需要发布相关服务的迭代即可，降低了测试的工作量同时也降低了服务发布的风险。</p>
<p>&emsp;&emsp;在微服务架构下，当某一组件发生故障时，故障会被隔离在单个服务中。如通过限流、熔断等方式降低错误导致的危害，保障核心业务的正常运行。</p>
<h5 id="第二章-微服务的拆分-1"><a href="#第二章-微服务的拆分-1" class="headerlink" title="第二章 微服务的拆分"></a>第二章 微服务的拆分</h5><h6 id="2-1-微服务的设计原则-1"><a href="#2-1-微服务的设计原则-1" class="headerlink" title="2.1 微服务的设计原则"></a>2.1 微服务的设计原则</h6><ul>
<li>高内聚、低耦合</li>
</ul>
<p>&emsp;&emsp;紧密关联的事应该放在一起，每个服务是针对一个单一职责的业务能力的封装，需要专注于做好一件事情。这样避免内容耦合，降低代码的冗余，提高代码的可复用性。</p>
<p>&emsp;&emsp;避免服务之间的数据库的共享。这样既可以减少数据库的并发操作，又可以避免死锁的出现。通常微服务不会直接共用一个数据库，可以通过主、从表的方式来进行，结合读、写分离，实现数据的共享。</p>
<p>&emsp;&emsp;微服务之间应该是轻量级的通信方式，主要是为了解耦，降低业务的复杂性，以及服务的负载。一个服务调用另一个服务应该是不受到后者的牵制，如果后者发生宕机，前者应该照样继续运行下去，这才是微服务设计时的合理安排。为了降低前者的不受牵制，这就需要轻量级的通信，比如：异步调用、重试策略等。</p>
<ul>
<li>以业务为中心</li>
</ul>
<p>&emsp;&emsp;每个服务代表了特定的业务逻辑，不应该掺着其他业务的逻辑，或微不足道的、公共的逻辑。</p>
<p>&emsp;&emsp;围绕业务开展，主要就当前业务进行扩展。</p>
<p>&emsp;&emsp;能快速的响应业务的变化，需要做到接口的兼容性，兼容业务场景的变化，这样减少变动太大带来的风险。</p>
<p>&emsp;&emsp;隔离实现细节，让业务领域可以被重用，需要以封装接口形式来实现业务逻辑，这就涉及到代码的复用性。引用 Java 的原理：封装、继承、多态。</p>
<ul>
<li>弹性容错设计</li>
</ul>
<p>&emsp;&emsp;设计可容错的系统：拥抱失败，为已知的错误而设计，这主要是为了增强交互。</p>
<p>&emsp;&emsp;可防御的系统：服务降级、服务隔离、请求限制、防止级联错误等，这也是为了增强交互的友好。</p>
<ul>
<li>自治和高可用</li>
</ul>
<p>&emsp;&emsp;独立开发和业务扩展，这就涉及到服务随着业务的发展而进行兼容、合理的扩展后的高度自治。</p>
<p>&emsp;&emsp;独立部署、运行和高可用，避免单点的孤注一掷。</p>
<ul>
<li>日志与监控</li>
</ul>
<p>&emsp;&emsp;聚合系统日志、数据，从而当遇到问题时，可以深入分析原因。</p>
<p>&emsp;&emsp;当需要重现问题时，可以根据日志以及监控来复盘。</p>
<p>&emsp;&emsp;监控主要包括服务状态、请求流量、调用链、API 错误计数，结构化的日志、服务依赖关系可视化等内容，以便发现问题及时修复，实时调整系统负载，必要时进行服务降级，过载保护等等，从而让系统和环境提供高效高质量的服务。</p>
<ul>
<li>自动化</li>
</ul>
<p>&emsp;&emsp;降低部署和发布的难度，如：在持续集成和持续交付中，自动化编译，测试，安全扫描，打包，集成测试，部署。随着服务越来越多，在发布过程中，需要进一步自动化金丝雀部署。</p>
<p>&emsp;&emsp;利用 K8s 等进行服务自动弹性伸缩等。</p>
<h6 id="2-2-微服务划分的粒度-1"><a href="#2-2-微服务划分的粒度-1" class="headerlink" title="2.2 微服务划分的粒度"></a>2.2 微服务划分的粒度</h6><p>&emsp;&emsp;服务的划分，可以从水平的功能划分，也可从垂直的业务划分，粒度的大小，可以根据当前的产品需求来定位，最关键的是要做到：<strong>高内聚、低耦合</strong>。</p>
<p>&emsp;&emsp;如电商系统为例，如下图：</p>
<p><img src="https://static001.geekbang.org/infoq/cc/cc086c43f4f5b547f2e3405d26ff7ae8.jpeg" alt=""></p>
<p>&emsp;&emsp;电商中涉及到业务很可能是最多的，商品、库存、订单、促销、支付、会员、购物车、发票、店铺等等，这个是根据业务的不同来进行模块的划分。微服务划分的粒度一定是要有明确性的，不能因为含糊而新增一个服务模块，这样会导致功能接口的可复用性差。一个好的架构设计，肯定是可复用性很强的结构模式。我喜欢这样的一句话：<strong>微服务的边界 (粒度) 是 “决策”, 而不是个 “标准答案”</strong>。即应该将各微服务划分的方式，深度思考，周全的考量各方面的因素下，所作出的一个”最适合”的架构决策，而不是一个人芸亦芸的”标准答案“。</p>
<h6 id="2-3-不同场景的微服务-1"><a href="#2-3-不同场景的微服务-1" class="headerlink" title="2.3 不同场景的微服务"></a>2.3 不同场景的微服务</h6><p>&emsp;&emsp;微服务的应用场景也是很多的，电商场景是比较常见的，比如阿里的体系：淘宝、支付宝、钉钉、饿了么、咸鱼、口碑等。电商场景的微服务实相对比较复杂的，所以需要更好的做好微服务的拆分以及扩展。</p>
<p>&emsp;&emsp;金融系统中也存在微服务的场景，比如：银行系统、证券系统、金融公司、机构。其需要考虑的重点是微服务的安全性、可靠性。</p>
<h5 id="第三章-容器化技术-1"><a href="#第三章-容器化技术-1" class="headerlink" title="第三章 容器化技术"></a>第三章 容器化技术</h5><h6 id="3-1-什么是容器-1"><a href="#3-1-什么是容器-1" class="headerlink" title="3.1 什么是容器"></a>3.1 什么是容器</h6><p>&emsp;&emsp;什么是容器呢？自然界的解释：容器是指用以容纳物料并以壳体为主的基本装置。但今天讲的容器也是一个容纳物质的载体。那计算机所指的容器(Container)到底是什么呢？容器是镜像（Image）的运行时实例。正如从虚拟机模板上启动 VM 一样，用户也同样可以从单个镜像上启动一个或多个容器。虚拟机和容器最大的区别是容器更快并且更轻量级，与虚拟机运行在完整的操作系统之上相比，容器会共享其所在主机的操作系统/内核。</p>
<p>&emsp;&emsp;为什么要用容器呢？假设你在使用一台电脑开发一个应用，而且开发环境具有特定的配置。其他开发人员身处的环境配置可能稍有不同。你正在开发的应用不止依赖于您当前的配置，还需要某些特定的库、依赖项和文件。与此同时，你的企业还拥有标准化的开发和生产环境，有着自己的配置和一系列支持文件。你希望尽可能多在本地模拟这些环境，而不产生重新创建服务器环境的开销。这时候，就会需要容器来模拟这些环境。</p>
<p>&emsp;&emsp;我们常见的容器启动方式是 Docker，Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何 Linux 机器上，也可以实现虚拟化。</p>
<p><img src="https://static001.geekbang.org/infoq/04/04a9b140ed18d59ceb7ccbeb2155e737.jpeg" alt=""></p>
<h6 id="3-2-容器的发展进程-1"><a href="#3-2-容器的发展进程-1" class="headerlink" title="3.2 容器的发展进程"></a>3.2 容器的发展进程</h6><p>&emsp;&emsp;2010 年，几个年轻小伙在旧金山成立了一家做 PaaS 平台的公司，起名为”dotCloud”，该公司主要是基于 PaaS 平台为开发者或开发商提供技术服务。他们提供了对多种运行环境支持。但随着市场接受度、规模、加上科技巨头等影响，有一天 dotCloud 的创始人 Solomon Hykes 就召集了公司核心开发人员，商量准备开源 Docker 技术。因此，在 2013 年 3 月，Docker 正式以开源软件形式在 pycon 网站(见下图)首次发布了。正式由于这次开源，让容器领域焕发了第二春。后来在美国，几乎所有的云计算厂商都在拥抱 Docker 这个生态圈。很快 Docker 技术风靡全球，于是，dotCloud 决定改名为 Docker Inc(下面简称”Docker”)，全身心投入到 Docker 的开发中。更名后的 Docker 并于 2014 年 8 月，Docker 宣布把平台即服务的业务 dotCloud 出售给位于德国柏林的平台即服务提供商 cloudControl，自此 dotCloud 和 Docker 分道扬镳。</p>
<p><img src="https://static001.geekbang.org/infoq/d1/d14c4c065f26b524a66c33b93c7e6529.jpeg" alt=""></p>
<h6 id="3-3-Docker-与-Kubernetes-1"><a href="#3-3-Docker-与-Kubernetes-1" class="headerlink" title="3.3 Docker 与 Kubernetes"></a>3.3 Docker 与 Kubernetes</h6><p>&emsp;&emsp;Google 多年来一直使用容器作为交付应用程序的一种重要方式，且运行有一款名为 Borg 的编排工具。Google、RedHat 等公司为了对抗以 Docker 公司为核心的容器商业生态，他们一起成立了 CNCF(Cloud Native Computing Foundation)。当谷歌于 2014 年 3 月开始开发 Kubernetes 时，很明智的选择当时最流行的容器，没错，就是 Docker。Kubernetes 对 Docker 容器运行时的支持，迎来了大量的使用用户。Kubernetes 于 2014 年 6 月 6 日首次发布。这便有了容器编排工具 Kubernetes 的诞生。另外，CNCF 的目的是以开源的 K8S 为基础，使得 K8S 能够在容器编排方面能够覆盖更多的场景，提供更强的能力。K8S 必须面临 Swarm 和 Mesos 的挑战。Swarm 的强项是和 Docker 生态的天然无缝集成，Mesos 的强项是大规模集群的管理和调度。K8S 是 Google 基于公司已经使用了十多年的 Borg 项目进行了沉淀和升华才提出的一套框架。它的优点就是有一套完整的全新的设计理念，同时有 Google 的背书，而且在设计上有很强的扩展性，所以，最终 K8S 赢得了胜利，成为了容器生态的行业标准。</p>
<h6 id="3-4-K8s-容器化应用-1"><a href="#3-4-K8s-容器化应用-1" class="headerlink" title="3.4 K8s 容器化应用"></a>3.4 K8s 容器化应用</h6><p>&emsp;&emsp;前面说了，K8s 是一种编排容器管理容器工具，那么如何通过 K8s 来将服务容器化呢？</p>
<p>&emsp;&emsp;首先，我们来看看 K8s 如何使用？第一条就是编写配置文件，因为配置文件可以是 YAML 或者 JSON 格式的。为方便阅读与理解，在后面的讲解中，我会统一使用 YAML 文件来指代它们。 Kubernetes 跟 Docker 等很多项目最大的不同，就在于它不推荐你使用命令行的方式直接运行容器（虽然 Kubernetes 项目也支持这种方式，比如：kubectl run），而是希望你用 YAML 文件的方式，即：把容器的定义、参数、配置，统统记录在一个 YAML 文件中，然后用这样一句指令把它运行起来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f xxx.yaml</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这样做最直接的一个好处是：你会有一个文件能记录下 K8s 到底 run 了哪些东西。比如下面这个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: tomcat:10.0.5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;像这样的一个 YAML 文件，对应到 kubernetes 中，就是一个 API Object（API 对象）。当你为这个对象的各个字段填好值并提交给 Kubernetes 之后，Kubernetes 就会负责创建出这些对象所定义的容器或者其他类型的 API 资源。可以看到，这个 YAML 文件中的 Kind 字段，指定了这个 API 对象的类型（Type），是一个 Deployment。Deployment 是一个定义多副本应用（即多个副本 Pod）的对象。此外，Deployment 还负责在 Pod 定义发生变化时，对每个副本进行滚动更新（Rolling+Update）。</p>
<p>&emsp;&emsp;在上面这个 Yaml 文件中，我给它定义的 Pod 副本个数 (spec.replicas)是：2。但，这些 Pod 副本长啥样子呢？为此，我们定义了一个 Pod 模版（spec.template），这个模版描述了我想要创建的 Pod 的细节。在上面的例子里，这个 Pod 里只有一个容器，这个容器的镜像（spec.containers.image）是 tomcat=10.0.5，这个容器监听端口（containerPort）是 80。</p>
<p>&emsp;&emsp;需要注意的是，像这种，使用一种 API 对象（Deployment）管理另一种 API 对象（Pod）的方法，在 Kubernetes 中，叫作“控制器”模式（controller pattern）。在我们的这个 demo 中，Deployment 扮演的正是 Pod 的控制器的角色。而 Pod 是 Kubernetes 世界里的应用；而一个应用，可以由多个容器（container）组成。为了让我们这个 tomcat 服务容器化运行起来，我们只需要执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl create -f tomcat-deployment.yaml</span><br><span class="line">deployment.apps&#x2F;tomcat-deployment created</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;执行完上面的命令后，你就可以看容器运行情况，此时，只需要执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl get pod -l app&#x3D;tomcat</span><br><span class="line">NAME                                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">tomcat-deployment-799f46f546-7nxrj   1&#x2F;1     Running             0          77s</span><br><span class="line">tomcat-deployment-799f46f546-hp874   0&#x2F;1     Running             0          77s</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;’kubectl get’ 指令的作用，就是从 Kubernetes 里面获取（GET）指定的 API 对象。可以看到，在这里我还加上了一个 -l 参数，即获取所有匹配 app=nginx 标签的 Pod。需要注意的是，在命令行中，所有 key-value 格式的参数，都使用“=”而非“：”表示。 从这条指令返回的结果中，我们可以看到现在有两个 Pod 处于 Running 状态，也就意味着我们这个 Deployment 所管理的 Pod 都处于预期的状态。</p>
<p>&emsp;&emsp;此外， 你还可以使用 kubectl describe 命令，查看一个 API 对象的细节，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl describe pod tomcat-deployment-799f46f546-7nxrj</span><br><span class="line">Name:           tomcat-deployment-799f46f546-7nxrj</span><br><span class="line">Namespace:      default</span><br><span class="line">Priority:       0</span><br><span class="line">Node:           ca005&#x2F;10.10.2.5</span><br><span class="line">Start Time:     Thu, 08 Apr 2021 10:41:08 +0800</span><br><span class="line">Labels:         app&#x3D;tomcat</span><br><span class="line">                pod-template-hash&#x3D;799f46f546</span><br><span class="line">Annotations:    cni.projectcalico.org&#x2F;podIP: 20.162.35.234&#x2F;32</span><br><span class="line">Status:         Running</span><br><span class="line">IP:             20.162.35.234</span><br><span class="line">Controlled By:  ReplicaSet&#x2F;tomcat-deployment-799f46f546</span><br><span class="line">Containers:</span><br><span class="line">  tomcat:</span><br><span class="line">    Container ID:   docker:&#x2F;&#x2F;5a734248525617e950b7ce03ad7a19acd4ffbd71c67aacd9e3ec829d051b46d3</span><br><span class="line">    Image:          tomcat:10.0.5</span><br><span class="line">    Image ID:       docker-pullable:&#x2F;&#x2F;tomcat@sha256:2637c2c75e488fb3480492ff9b3d1948415151ea9c503a496c243ceb1800cbe4</span><br><span class="line">    Port:           80&#x2F;TCP</span><br><span class="line">    Host Port:      0&#x2F;TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Thu, 08 Apr 2021 10:41:58 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount from default-token-2ww52 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-2ww52:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-2ww52</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io&#x2F;not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io&#x2F;unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  4m17s  default-scheduler  Successfully assigned default&#x2F;tomcat-deployment-799f46f546-7nxrj to ca005</span><br><span class="line">  Normal  Pulling    4m16s  kubelet, ca005     Pulling image &quot;tomcat:10.0.5&quot;</span><br><span class="line">  Normal  Pulled     3m27s  kubelet, ca005     Successfully pulled image &quot;tomcat:10.0.5&quot;</span><br><span class="line">  Normal  Created    3m27s  kubelet, ca005     Created container tomcat</span><br><span class="line">  Normal  Started    3m27s  kubelet, ca005     Started container tomcat</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在 kubectl describe 命令返回的结果中，可以的清楚地看到这个 Pod 的详细信息，比如它的 IP 地址等等。其中，有一个部分值得你特别关注，它就是 Events（事件）。</p>
<p>&emsp;&emsp;在 Kubernetes 执行的过程中，对 API 对象的所有重要操作，都会被记录在这个对象的 Events 里，并且显示在 kubectl describe 指令返回的结果中。这些 Events 中的信息很重要，可以排查容器是否运行、正常运行的原因。</p>
<p>&emsp;&emsp;如果你希望升级 tomcat 的版本，那可以直接修改 Yaml 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: tomcat</span><br><span class="line">    image: tomcat:latest</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;修改完 Yaml 文件后，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f tomcat-deployment.yaml</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这样的操作方法，是 Kubernetes“声明式 API”所推荐的使用方法。也就是说，作为用户，你不必关心当前的操作是创建，还是更新，你执行的命令始终是 kubectl apply，而 Kubernetes 则会根据 YAML 文件的内容变化，自动进行具体的处理。</p>
<p>&emsp;&emsp;同时，可以查看容器内的服务的日志情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl logs -f tomcat-deployment-799f46f546-7nxrj</span><br><span class="line">NOTE: Picked up JDK_JAVA_OPTIONS:  --add-opens&#x3D;java.base&#x2F;java.lang&#x3D;ALL-UNNAMED --add-opens&#x3D;java.base&#x2F;java.io&#x3D;ALL-UNNAMED --add-opens&#x3D;java.base&#x2F;java.util&#x3D;ALL-UNNAMED --add-opens&#x3D;java.base&#x2F;java.util.concurrent&#x3D;ALL-UNNAMED --add-opens&#x3D;java.rmi&#x2F;sun.rmi.transport&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.037 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version name:   Apache Tomcat&#x2F;10.0.5</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server built:          Mar 30 2021 08:19:50 UTC</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version number: 10.0.5.0</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Name:               Linux</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Version:            4.4.0-116-generic</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Architecture:          amd64</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Java Home:             &#x2F;usr&#x2F;local&#x2F;openjdk-11</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Version:           11.0.10+9</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Vendor:            Oracle Corporation</span><br><span class="line">08-Apr-2021 02:41:59.040 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_BASE:         &#x2F;usr&#x2F;local&#x2F;tomcat</span><br><span class="line">08-Apr-2021 02:41:59.041 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_HOME:         &#x2F;usr&#x2F;local&#x2F;tomcat</span><br><span class="line">08-Apr-2021 02:41:59.051 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens&#x3D;java.base&#x2F;java.lang&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.051 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens&#x3D;java.base&#x2F;java.io&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.051 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens&#x3D;java.base&#x2F;java.util&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.051 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens&#x3D;java.base&#x2F;java.util.concurrent&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens&#x3D;java.rmi&#x2F;sun.rmi.transport&#x3D;ALL-UNNAMED</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;conf&#x2F;logging.properties</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.manager&#x3D;org.apache.juli.ClassLoaderLogManager</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djdk.tls.ephemeralDHKeySize&#x3D;2048</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.protocol.handler.pkgs&#x3D;org.apache.catalina.webresources</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dorg.apache.catalina.security.SecurityListener.UMASK&#x3D;0027</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dignore.endorsed.dirs&#x3D;</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.base&#x3D;&#x2F;usr&#x2F;local&#x2F;tomcat</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.home&#x3D;&#x2F;usr&#x2F;local&#x2F;tomcat</span><br><span class="line">08-Apr-2021 02:41:59.052 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.io.tmpdir&#x3D;&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;temp</span><br><span class="line">08-Apr-2021 02:41:59.056 INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent Loaded Apache Tomcat Native library [1.2.27] using APR version [1.6.5].</span><br><span class="line">08-Apr-2021 02:41:59.056 INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true], UDS [true].</span><br><span class="line">08-Apr-2021 02:41:59.059 INFO [main] org.apache.catalina.core.AprLifecycleListener.initializeSSL OpenSSL successfully initialized [OpenSSL 1.1.1d  10 Sep 2019]</span><br><span class="line">08-Apr-2021 02:41:59.312 INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler [&quot;http-nio-8080&quot;]</span><br><span class="line">08-Apr-2021 02:41:59.331 INFO [main] org.apache.catalina.startup.Catalina.load Server initialization in [441] milliseconds</span><br><span class="line">08-Apr-2021 02:41:59.369 INFO [main] org.apache.catalina.core.StandardService.startInternal Starting service [Catalina]</span><br><span class="line">08-Apr-2021 02:41:59.370 INFO [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet engine: [Apache Tomcat&#x2F;10.0.5]</span><br><span class="line">08-Apr-2021 02:41:59.377 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-nio-8080&quot;]</span><br><span class="line">08-Apr-2021 02:41:59.392 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in [61] milliseconds</span><br></pre></td></tr></table></figure>

<h5 id="第四章-为何借助容器助力微服务-1"><a href="#第四章-为何借助容器助力微服务-1" class="headerlink" title="第四章 为何借助容器助力微服务"></a>第四章 为何借助容器助力微服务</h5><h6 id="4-1-微服务的多语言性-1"><a href="#4-1-微服务的多语言性-1" class="headerlink" title="4.1 微服务的多语言性"></a>4.1 微服务的多语言性</h6><p>&emsp;&emsp;微服务可以说是越来越火了：那么对于语言场景，从 Java 中的 Spring MVC，到后面的 SOA、Dubbo、Spring Cloud、Spring cloud Alibaba 等。这是单纯 Java 语言的微服务的发展史，那么对于 Python、Go 呢？其实也是有其微服务设计理念的，比如 Golang 的 beego、gin 等。</p>
<p>&emsp;&emsp;这么多的微服务框架，都是独立、限制于自己的体系，撇开其它技术不说，Java 可以自成生态体系，Golang 亦是。其实微服务不应该受某种语言的限制，各种语言的服务之间应该可以互通：这在云原生时代设计中，它们都被称为 Service。后面会介绍对于不同语言的服务（Service）如何在云原生中互通。</p>
<h6 id="4-2-微服务的高可用-1"><a href="#4-2-微服务的高可用-1" class="headerlink" title="4.2 微服务的高可用"></a>4.2 微服务的高可用</h6><p>&emsp;&emsp;微服务出现后，同样面临着一个重要的话题：高可用。所谓<strong>高可用</strong>：英文缩写 HA(High Availability)，是指当某个服务或服务所在节点出现故障时，其对外的功能可以转移到该服务其他的副本或该服务在其他节点的副本，从而在减少停工时间的前提下，满足业务的持续性，这两个或多个服务构成了服务高可用。同时，这种高可用需要考虑到服务的性能压力，即服务的负载均衡。</p>
<p>&emsp;&emsp;我们知道对于服务的高可用，或者说服务的负载来说，有很多方式来解决这些问题。比如：</p>
<ul>
<li>主从方式，其工作原理是：主机处于工作状态，备机处于监控、准备状态，当主机出现宕机的情况下，备机可以接管主机的一切工作，等到主机恢复正常后，将会手动或自动的方式将服务切换到主机上运行，数据的一致性通过共享存储来实现。</li>
<li>集群方式，其工作原理是：多台机器同时运行一个或几个服务，当其中的某个节点出现宕机时，这时该节点的服务将无法提供业务功能，可以选择根据一定的机制，将服务请求转移到该服务所在的其他节点上，这样可以让逻辑持续的执行下去，即消除软件单点故障。这其实就涉及到负载均衡策略。</li>
</ul>
<p>&emsp;&emsp;对于微服务的<strong>高可用</strong>，涉及到的其中一个就是其服务的负载均衡。在微服务中，负载均衡的前提是，同一个服务需要被发现多个，或者说多个副本，这样才能实现负载均衡以及服务的高可用。那么，怎么让服务被发现呢？我们来看一张图：</p>
<p><img src="https://static001.geekbang.org/infoq/26/2670441bb586695aa5eea48a910f1447.png" alt=""><br>&emsp;&emsp;在上图中，我们可以看到：</p>
<ul>
<li>1.各微服务先往注册中心 Eureka 注册服务。</li>
<li>2.各微服务保持与注册中心心跳。</li>
<li>3.注册中心发现各微服务。</li>
<li>4.注册中心根据配置规则定期获取心跳，超时即认为节点无效。</li>
<li>5.根据规则来定期清理无效节点。</li>
</ul>
<p>&emsp;&emsp;这是基于注册中心 Eureka 的服务注册与发现，同样，基于其他的注册中心实现原理基本类似。如：Eureka、Zookeeper、Consul、etcd、nacos 等。其实，在云原生 K8s 中，也存在着服务的注册与发现，这在后面章节中会讲解。</p>
<p>&emsp;&emsp;服务发现后，其实面临的是一个主要的问题就是应该访问哪一个？因为发现了某个服务的多个实例，最终只会访问其中某一个，这就涉及到服务的负载均衡了。</p>
<p>&emsp;&emsp;负载均衡在微服务中是一个很常见的话题，实现负载均衡的插件也越来越多。netflix 开源的 Zuul、Gateway 等等，其实 K8s 中也存在着负载均衡器：kube-dns、kube-proxy。</p>
<p>&emsp;&emsp;在实现服务注册与发现、负载均衡后，其实高可用还涉及很多：高并发、缓存等。先讲讲<strong>高并发</strong>：</p>
<ul>
<li>幂等性</li>
<li>接口代码的规范性</li>
<li>操作 DB 的性能</li>
<li>读写分离操作</li>
<li>服务的横向扩展</li>
<li>服务的健壮性（缓存、限流、熔灾）</li>
</ul>
<p>&emsp;&emsp;其中，幂等性：就是说一次和多次请求某一个资源时对于资源本身应该具有同样的结果（网络超时等问题除外）。也就是说，其任意次执行所产生的效果和返回的结果都是一样的。这种场景是一个很有效的实现高并发的情景，设想，用户充值某个会员，在并发情况下，用户由于误操作，或者由于网络、时间等问题导致重试机制的发生时，可能会触发触发多次交易的扣费，这样给用户一个很不好的体验。此时，就需要接口幂等性来解决这类问题。</p>
<p>&emsp;&emsp;幂等性解决方案有以下几种：</p>
<ul>
<li>token 机制</li>
<li>接口逻辑实现幂等性</li>
<li>数据库层处理实现幂等性</li>
</ul>
<p>&emsp;&emsp;token 机制：数据提交时携带 token，token 放到 redis，token 有效时间，提交后台后校验 token，同时删除 token，生成新的 token 并返回。</p>
<p>&emsp;&emsp;接口的幂等性：常见的接口幂等性，是定义接口时，加上参数序列号、来源等，序列号与请求来源联合唯一索引，这样可以有效判断本次请求方与请求的序列号，防止重复的请求。</p>
<p>&emsp;&emsp;数据库处理：DB 层处理有多种方式：1. 悲观锁，2. 乐观锁，3. 唯一索引、组合唯一索引，4. 分布式锁。</p>
<p>&emsp;&emsp;悲观锁：所谓悲观锁，是指存在危机意识，事先(查询时)加锁处理，防止事情发生。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from xxx where id&#x3D; 1 for update</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;乐观锁：是指存在乐观心理，只在更新时加锁，乐观锁通常用 version 版本号来控制如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update xxx set name&#x3D;#name#,version&#x3D;version+1 where version&#x3D;#version#</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;也可以通过条件限制，这里就使用了组合唯一索引来处理，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update xxx set name&#x3D;#name#,version&#x3D;version+1 where id&#x3D;#id# and version&#x3D;#version#</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;分布式锁：通过 redis、zookeeper 来设置分布式锁，当插入或更新数据时，获取分布式锁，然后做操作，之后释放锁。</p>
<p>&emsp;&emsp;接口的规范性：接口的性能如何，最终还是跟接口的实现逻辑有关，比如代码规范，逻辑实现等，尤其是业务逻辑复杂的情况下，这点需要注意的。</p>
<p>&emsp;&emsp;操作 DB：对于业务的持久层，用的比较多的就是 mybatis、hibernate，还有可能是 JPA，无论是哪个，最终都是通过工厂类注入 bean，最后执行 SQL 来操作 DB。所以这里尤为重要的是 SQL 的写法，SQL 的优化决定着操作 DB 的时间以及效果，如果写得不好的话，则会导致死循环，或死锁，或内存溢出。另外测试时，使用真实、规范的数据进行测试，并在测试时不要局限于相同的数据，最后就是并发压测了。</p>
<p>&emsp;&emsp;读写分离：当服务足够多，数据足够多时，有可能读与写的占比为：10:1，此时读写应该分离，这样可以有效减少因为读的频繁操作导致的写的性能下降。常见的读写分离的方法有：采用 mycat 中间件方式、amoeba 直接实现读写分离、手动修改 mysql 操作类直接实现读写分离和随机实现的负载均衡，权限独立分配、mysql-proxy（还是测试版本，时间消耗有点高）。</p>
<p>&emsp;&emsp;服务的横向扩展：对于服务的请求越来越多时，此时需要对服务进行多节点部署，这样减少单机带来的服务负载压力。</p>
<p>&emsp;&emsp;服务的健壮性：服务的健壮性包括缓存、限流、熔灾。</p>
<p>&emsp;&emsp;对于缓存，大家都知道，有常见的许多中间件如：redis、kafka、RabbitMq、zookeeper。对于一些 session 等常用 redis 来缓存、共享。对于一些大一点的数据如果嫌弃加载慢，也可以采用缓存机制来解决。</p>
<p>&emsp;&emsp;什么叫限流呢？很好理解，就是限制节点的流量，限制服务的请求数。那么如何做到限流呢？常用的限流算法比如有计数器算法、令牌桶算法、漏桶算法。有几种方式：利用 springcloud 组件 zuul 来对请求进行限流，主要是通过谷歌提供的 RateLimiter 结合一些限流算法来限流比较常用。利用 redis 同样可以做限流算法的，甚至可以利用 nginx 直接作计数限流，可以对请求速率进行限制、对每个 ip 连接数量进行限制、对每个服务的连接数量进行限制。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#对请求速率进行限制</span><br><span class="line">limit_req_zone $binary_remote_addr zone&#x3D;req_one:20m rate&#x3D;12r&#x2F;s;</span><br><span class="line">limit_conn_zone $binary_remote_addr zone&#x3D;addr:10m;</span><br><span class="line">#对每个ip连接数量进行限制</span><br><span class="line">limit_conn_zone $server_name zone&#x3D;perserver:20m;</span><br><span class="line">#对每个服务的连接数量进行限制</span><br><span class="line">server&#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;ip:port;</span><br><span class="line">    limit_req zone&#x3D;req_one burst&#x3D; 80 nodelay;</span><br><span class="line">    limit_conn addr 20;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;其实在 Springboot2.x 中，推出自己的 Spring-Cloud-Gateway 来作网关，同时 Spring-Cloud-Gateway 中提供了基于 Redis 的实现来达到限流的目的。对于其它框架，都有加入限流的插件功能。</p>
<p>&emsp;&emsp;对于熔灾，或者说熔断，这个在实际的业务当中是很有必要的。比如：用户在某一商城秒杀某一件物品，或在某米商城上抢购某一部手机，在准点抢购时，发现人很多，请求很多，这时，主要是需要有限流机制，同时也需要有熔灾（熔断），给用户留下一个很好的体验的感觉。当用户在点击抢购按钮后，如果当前的请求数很多，需要用户等待，这是需要给一个友好的界面让用户去等待，而不是直接给用户提示请求失败，或者报异常，这样的红色抛出是一个非常不好的事情，用户可能会骂街的，下次也不会逛了。</p>
<p>&emsp;&emsp;Spring-Cloud-Gateway 作网关时，过滤器时使用 HystrixGatewayFilterFactory 来创建一个 Filter 实现基于 Route 级别的熔断功能。</p>
<p>&emsp;&emsp;对于缓存问题，随着系统用户的越来愈多，所有的服务压力也会指数型递增，这时候缓存是一个很好的减轻服务压力的方式。这样可以有效缓冲请求对服务的负载压力。常见的缓存可能是 Redis、MQ(RabbitMQ、RocketMQ)、Kafka、ZooKeeper 等。</p>
<p>&emsp;&emsp;Redis 一般主要做 session 或用户信息的缓存，实现多机中 session 的共享。也会用来作分布式锁，在分布式高并发下实现锁的功能，例如实现秒杀、抢单等功能。还会被用作一些订单信息的缓存，防止大量的订单信息被积压而导致服务器的负载很高。总之，Redis 常被用来作为一种缓冲剂使用。</p>
<p>&emsp;&emsp;MQ 常见的有 RabbitMQ、RocketMQ、ActiveMQ、Kafka 等，以下是各种之间的对比：</p>
<table cellspacing="0"><tbody><tr style="height:17px;"><td width="68" valign="top" style="padding: 8px 14px;border-width: 1px;border-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">特性</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top-width: 1px;border-top-color: rgb(192, 192, 192);border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">ActiveMQ</span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top-width: 1px;border-top-color: rgb(192, 192, 192);border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">RabbitMQ</span></p></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top-width: 1px;border-top-color: rgb(192, 192, 192);border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">RocketMQ</span></p></td><td width="136.33333333333334" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top-width: 1px;border-top-color: rgb(192, 192, 192);border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">Kafka</span></p></td></tr><tr style="height:72px;"><td width="68" valign="top" style="padding: 8px 14px;border-left-width: 1px;border-left-color: rgb(192, 192, 192);border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">单机吞吐量</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">万级，吞吐量比RocketMQ<span style="font-family:pingfang sc;">和</span><span style="font-family:Trebuchet MS;">Kafka</span><span style="font-family:pingfang sc;">要低了一个数量级</span></span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">万级，吞吐量比RocketMQ<span style="font-family:pingfang sc;">和</span><span style="font-family:Trebuchet MS;">Kafka</span><span style="font-family:pingfang sc;">要低了一个数量级</span></span></p></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">10<span style="font-family:pingfang sc;">万级，</span><span style="font-family:Trebuchet MS;">RocketMQ</span><span style="font-family:pingfang sc;">也是可以支撑高吞吐的一种</span><span style="font-family:Trebuchet MS;">MQ</span></span></p></td><td width="171" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">10<span style="font-family:pingfang sc;">万级别，这是</span><span style="font-family:Trebuchet MS;">kafka</span><span style="font-family:pingfang sc;">最大的优点，就是吞吐量高。</span>一般配合大数据类的系统来进行实时数据计算、日志采集等场景</span></p></td></tr><tr style="height:41px;"><td width="68" valign="top" style="padding: 8px 14px;border-left-width: 1px;border-left-color: rgb(192, 192, 192);border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">时效性</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">ms级</span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);word-break: break-all;"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">微秒级</span></p></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">ms级</span></p></td><td width="171" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">延迟在ms<span style="font-family:pingfang sc;">级以内</span></span></p></td></tr><tr style="height:76px;"><td width="68" valign="top" style="padding: 8px 14px;border-left-width: 1px;border-left-color: rgb(192, 192, 192);border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">可用性</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">高，基于主从架构实现高可用性</span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">高，基于主从架构实现高可用性</span></p></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">非常高，分布式架构</span></p></td><td width="171" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">非常高，kafka<span style="font-family:pingfang sc;">是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</span></span></p></td></tr><tr style="height:71px;"><td width="68" valign="top" style="padding: 8px 14px;border-left-width: 1px;border-left-color: rgb(192, 192, 192);border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">消息可靠性</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">有较低的概率丢失数据</span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><br></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">经过参数优化配置，可以做到0<span style="font-family:pingfang sc;">丢失</span></span></p></td><td width="171" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">经过参数优化配置，消息可以做到0<span style="font-family:pingfang sc;">丢失</span></span></p></td></tr><tr style="height:101px;"><td width="68" valign="top" style="padding: 8px 14px;border-left-width: 1px;border-left-color: rgb(192, 192, 192);border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">功能支持</span></p></td><td width="101" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">MQ<span style="font-family:pingfang sc;">领域的功能极其完备</span></span></p></td><td width="119" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">基于erlang<span style="font-family:pingfang sc;">开发，所以并发能力很强，性能极其好，延时很低</span></span></p></td><td width="148" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">MQ<span style="font-family:pingfang sc;">功能较为完善，还是分布式的，扩展性好</span></span></p></td><td width="171" valign="top" style="padding: 8px 14px;border-left: none;border-right-width: 1px;border-right-color: rgb(192, 192, 192);border-top: none;border-bottom-width: 1px;border-bottom-color: rgb(192, 192, 192);background: rgb(238, 238, 238);word-break: break-all;"><p style="font-family: 10px 0;text-indent: 0;"><span style="color: rgb(0, 0, 0);letter-spacing: 0;font-size: 10px;">功能较为简单，主要支持简单的MQ<span style="font-family:pingfang sc;">功能，在大数据领域的实时计算以及日志采集被大规模使用，是事实上的标准</span></span></p></td></tr></tbody></table>

<p>&emsp;&emsp;ZooKeeper 也是经常会存储海量数据，例如 Hadoop 中，在使用 YARN 作资源调度时，采用 ZooKeeper 来存储海量的状态机状态以及任务的信息（包括历史信息）。</p>
<h6 id="4-3-微服务的复杂性-1"><a href="#4-3-微服务的复杂性-1" class="headerlink" title="4.3 微服务的复杂性"></a>4.3 微服务的复杂性</h6><p>&emsp;&emsp;说起微服务，使用 DDD 划分微服务的好处的时候，经常会说 DDD 能够让相关的业务逻辑更加内聚，并且降低服务之间的耦合性，从而最终实现达到降解系统的复杂性。但是在这里，不论是高内聚，低耦合，甚至我们经常说的系统复杂性，我们有没有一个客观的可以量化的指标来衡量这些概念。由于无法量化，所以就没法度量，这样当团队在讨论一个系统是否复杂，有多复杂这些问题的时候，就很容易陷入各种主观直觉的争论中。</p>
<p>&emsp;&emsp;互联网时代，这些巨多的系统在细节上不一样，但是如果从抽象层面来看有很多共性，一个微服务系统由很多个微服务组成，这些微服务的行为产生出复杂的行为模式。整个微服务系统会通过 API 利用内部或外部的信号，同时在系统内部也是通过服务之间的接口进行信息传递。一个微服务系统并不是静态的，而是会不断适应业务变化，改变系统的 API 或者系统内部的组织方式来增加生存的机会。</p>
<p>&emsp;&emsp;微服务的复杂，不仅仅在于其系统本身，还需要考虑的是：高可用、服务自治、服务并发、服务限流、熔灾等。</p>
<p>&emsp;&emsp;服务的高可用在上一节中已经说明了，服务自治，目的其实是在对其修改时对其他部分造成尽可能小的影响；自治服务运营时也不会对其他服务的功能造成影响。服务几乎总是要依赖其他服务提供的数据。例如，网上商城都有一个购物车微服务，一些其他服务必须能向购物车添加商品，还必须能访问购物车内的商品并下单和配送。现在问题是，如何在保持服务尽可能自治的前提下实现对接。那需要遵循一定的模式：交互、信息传递。</p>
<p>&emsp;&emsp;交互模式：Request-Reply 还是 Publish-Subscribe</p>
<ul>
<li>Request-Reply（请求-应答）意味着一个服务处理信息的特定请求或者执行一些动作并返回一个应答。发起调用的服务需要知道去哪儿请求以及请求些什么？这种模式仍然可以被实现为异步执行，并且你还可以做一些抽象使服务调用方不需要知道被调用服务的物理地址，不能逃避的一点是服务必须明确的要求一个特定的信息和功能（或者执行动作）并等待应答。</li>
<li>Publish-Subscribe（发布-订阅） 这种模式下的服务将自己注册为对特定的信息感兴趣，或者能够处理特定的请求，相关的信息和请求将被交付给它，并且它可以决定怎么处理这些信息和请求。本文假定有一些中间件能够处理交付或者发布消息给订阅这些消息服务。</li>
</ul>
<p>&emsp;&emsp;信息传递：Events 还是 Queries/Commands</p>
<ul>
<li>Events（事件）是没有争议的事实，比如订单号 123 的订单已经创建，事件只陈述发生了什么事，不描述这样一个事件会导致什么事情发生。</li>
<li>Queries/Commands（查询/命令）两者都传达了什么事情会发生，查询是对信息的特定请求，命令是要求一个服务执行一些动作的特定请求。</li>
</ul>
<p>&emsp;&emsp;上面的四种即可作为微服务间对接的四种方式：<strong>REQUEST-REPLY WITH EVENTS</strong>、<strong>REQUEST-REPLY WITH COMMANDS/QUERIES</strong>、<strong>PUBLISH-SUBSCRIBE WITH EVENTS</strong>、<strong>PUBLISH-SUBSCRIBE WITH COMMANDS/QUERIES</strong>。</p>
<ul>
<li><p>REQUEST-REPLY WITH EVENTS，在这种模式下，一个服务请求另一个导致事件发生的特定服务，这意味着这两种服务之间有很强的依赖。配送服务必须知道要连接那个服务来获得订单相关的事件，这也导致了运行时依赖，因为配送服务只有在订单服务可用的时候才能配送新订单。</p>
<blockquote>
<blockquote>
<p>  既然配送服务只接收事件，它基于事件里的信息自己决定何时一个订单可以被配送，订单服务不需要知道配送服务的任何信息，它只是简单的提供事件表明当其他服务请求时订单进行怎样的处理，把响应事件的职责完全交给请求事件的服务。</p>
</blockquote>
</blockquote>
</li>
<li><p>REQUEST-REPLY WITH COMMANDS/QUERIES，如：订单服务将请求配送服务来配送一个订单，这意味着强烈的依赖，因为订单服务明确的请求一个特定的服务来处理配送，现在订单服务必须决定何时一个订单准备好配送，它意识到配送服务的存在，甚至知道怎样与配送服务交互，在订单配送前需要考虑是否有其他因素关联到订单（比如客户信用卡状态），订单服务在请求配送服务来配送订单前也需要考虑这一点。现在业务处理被混到了架构里，因此架构不能被简单的修改。这也是运行时依赖，因为订单服务必须确保配送请求成功交付给了配送服务。</p>
</li>
<li><p>PUBLISH-SUBSCRIBE WITH EVENTS，配送服务注册自己对订单相关的事件感兴趣，注册后，配送服务会收到订单的所有事件而不需要关心订单事件的来源，这是对订单事件来源的松散耦合，配送服务需要保留接收到事件的副本，这样就可以决定何时订单准备好配送。订单服务需要对配送无关，如果多个服务提供包含配送服务需要的相关数据的订单相关事件，配送服务应该不可识别，如果一个提供订单事件的服务宕机，配送服务也应该不知道，只是收到的事件变少了，配送服务不会因此阻塞。</p>
</li>
<li><p>PUBLISH-SUBSCRIBE WITH COMMANDS/QUERIES，配送服务自己注册为能够配送货物的服务，接受所有想要配送货物的命令，配送服务不需要意识到配送命令的来源，同样订单服务业不知道那些服务将处理配送，在这个意义上说，他们是松散耦合的，不过，订单服务知道既然发送了配送命令，订单必须被配送的事实，这确实让耦合更强了。</p>
</li>
</ul>
<p>&emsp;&emsp;两种 Request-Reply 模式都意味着两个服务的运行时耦合和强耦合，两种 Command/Queries 模式意味着一个服务知道另一个服务应该做的事，这也意味着强耦合，但是这一次在功能级别。留下了一个选项：PUBLISH-SUBSCRIBE WITH EVENTS，这种情况下，两种服务从运行时和功能的角度都没有意识到彼此的存在。</p>
<p>&emsp;&emsp;<strong>但是，我们需要考虑更多的因素，一直使用这种方式交互是有代价的，例如，数据被复制、事件丢失、事件驱动的架构增加更多基础设施的需求、额外的延迟。</strong></p>
<h4 id="第二部分-原理与应用-1"><a href="#第二部分-原理与应用-1" class="headerlink" title="第二部分 原理与应用"></a>第二部分 原理与应用</h4><h5 id="第五章-Kubernetes-介绍-1"><a href="#第五章-Kubernetes-介绍-1" class="headerlink" title="第五章 Kubernetes 介绍"></a>第五章 Kubernetes 介绍</h5><h6 id="5-1-Kubernetes-的基本概念与特性-1"><a href="#5-1-Kubernetes-的基本概念与特性-1" class="headerlink" title="5.1 Kubernetes 的基本概念与特性"></a>5.1 Kubernetes 的基本概念与特性</h6><p>&emsp;&emsp;在前面的章节中介绍了 Kubernetes 的由来，那么 Kubernetes 到底是干嘛的呢？这就涉及到 Kubernetes 的定义以及其特性，本节来描述下 Kubernetes 的特性以及应用场景。</p>
<p>&emsp;&emsp;Kubernetes，简称 K8s，是把 8 代替了 8 个字符“ubernete”而成的缩写。K8s 是一个一个开源的，用于管理云平台中多个主机上的容器化的应用编排工具。它的目标是让部署容器化的应用简单且高效，Kubernetes 提供了应用部署，规划，更新，维护的一种机制。</p>
<p>&emsp;&emsp;Kubernetes 是 Google 开源的一个容器编排引擎，支持自动化部署、大规模可伸缩、应用容器化管理。在生产环境中部署一个应用程序时，通常要部署该应用的多个实例以便对应用请求进行负载均衡。在 Kubernetes 中，我们可以创建多个容器，每个容器里面运行一个应用实例，然后通过内置的负载均衡策略，实现对这一组应用实例的管理、发现、访问，而这些细节都不需要运维人员去进行复杂的手工配置和处理。</p>
<p>&emsp;&emsp;特性：</p>
<ul>
<li>可移植: 支持公有云，私有云，混合云</li>
<li>可扩展: 模块化，插件化，可挂载，可组合</li>
<li>自动化: 自动部署，自动重启，自动复制，自动弹性伸缩</li>
</ul>
<p>&emsp;&emsp;可移植，意味着可以穿梭任何系统，不受系统的限制，也不受任何语言的限制，支持任何的其他的服务形式。</p>
<p>&emsp;&emsp;可扩展，是指 K8s 的各个模块之间是解耦合的，可以增加插件来丰富其功能，也可以替换其组件来达到想要的效果。</p>
<p>&emsp;&emsp;自动部署和回滚，K8s 采用滚动更新策略更新应用，一次更新一个 Pod，而不是同时删除所有 Pod，如果更新过程中出现问题，将回滚更改，确保升级不受影响业务。</p>
<p>&emsp;&emsp;弹性伸缩，使用命令、UI 或者基于 CPU 使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。</p>
<p>&emsp;&emsp;自动重启，是说在集群节点宕机、机器重启后，其 K8s 集群具有自动重启的功能，同时，会拉起集群中所有的应用服务，这就是其编排能力的一个体现。</p>
<p>&emsp;&emsp;自动复制，是指所有相关的数据，可以被备份到 etcd 或其它插件中，以便 K8s 可以通过 controllers、scheduler 来很好的编排。</p>
<p>&emsp;&emsp;可挂载，是指存储编排，挂载外部存储系统，无论是来自本地存储，公有云（如 AWS），还是网络存储（如 NFS、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性。</p>
<p>&emsp;&emsp;自我修复，在节点故障时重新启动失败的容器，替换和重新部署，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保线上服务不中断。</p>
<h6 id="5-2-部署-Kubernetes-集群-1"><a href="#5-2-部署-Kubernetes-集群-1" class="headerlink" title="5.2 部署 Kubernetes 集群"></a>5.2 部署 Kubernetes 集群</h6><p>&emsp;&emsp;如果想要了解 K8s 的一些特性，并且将其应运的很好，那就需要动手部署一个 K8s 集群。下面讲解下 K8s 集群部署流程。</p>
<h6 id="单机版-K8s"><a href="#单机版-K8s" class="headerlink" title="单机版 K8s"></a>单机版 K8s</h6><p>&emsp;&emsp;<strong>环境：</strong></p>
<ul>
<li>Ubuntu 16.04</li>
<li>GPU 驱动 418.56</li>
<li>Docker 18.06</li>
<li>K8s 1.13.5</li>
</ul>
<p>以上的环境，针对的是高版本的 K8s，而且 Docker 的版本必须要注意。另外 GPU 驱动的话，如果大家是非 GPU 机器的话，可以考虑不用。如果含有 GPU 机器的话，需要安装驱动，并且驱动版本不能过低喔。</p>
<h4 id="设置环境"><a href="#设置环境" class="headerlink" title="设置环境"></a>设置环境</h4><p>在配置环境前，首先备份一下源配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;etc&#x2F;apt&#x2F;sources.list &#x2F;etc&#x2F;apt&#x2F;sources.list.cp</span><br></pre></td></tr></table></figure>

<p>然后我们重新写一份配置，编辑内容，加上阿里源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line"></span><br><span class="line">deb-src http:&#x2F;&#x2F;archive.ubuntu.com&#x2F;ubuntu xenial main restricted</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial main restricted</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial main restricted multiverse universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-updates main restricted</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-updates main restricted multiverse universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-updates universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial multiverse</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-updates multiverse</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F;xenial-backports main restricted universe multiverse</span><br><span class="line">deb http:&#x2F;&#x2F;archive.canonical.com&#x2F;ubuntu xenial partner</span><br><span class="line">deb-src http:&#x2F;&#x2F;archive.canonical.com&#x2F;ubuntu xenial partner</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-security main restricted</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-security main restricted multiverse universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-security universe</span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; xenial-security multiverse</span><br></pre></td></tr></table></figure>

<p>添加好后，可以执行如下命令，更新一下源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<p>如果出现问题，可以执行如下命令来自动修复安装出现 broken 的 package：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt --fix-broken install</span><br></pre></td></tr></table></figure>

<p>执行升级命令时，注意：对于 GPU 机器可不执行，否则可能升级 GPU 驱动导致问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get upgrade</span><br></pre></td></tr></table></figure>

<p>由于 K8s 安装要求，需要关闭防火墙：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw disable</span><br></pre></td></tr></table></figure>

<p>安装 SELinux：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install selinux-utils</span><br></pre></td></tr></table></figure>

<p>SELinux 防火墙配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line">vim&#x2F;etc&#x2F;selinux&#x2F;conifg</span><br><span class="line"></span><br><span class="line">SELINUX&#x3D;disabled</span><br></pre></td></tr></table></figure>

<p>设置网络，将桥接的 IPV4 流量传递到 iptables 的链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tee &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf &lt;&lt;-&#39;EOF&#39;</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables &#x3D; 1</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>为了防止下面执行的会报错，可以先执行一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure>

<p>最后，查看 IPV4 与 v6 配置是否生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<p>配置 iptables：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;rc.local</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>

<p>需要永久关闭 swap 分区：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;s&#x2F;.*swap.*&#x2F;#&amp;&#x2F;&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>

<p>以上为 K8s 系统的环境配置，这个条件是硬性的，必须要处理。接下来就是安装需要的配套工具了。</p>
<h4 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h4><p>设置环境，在 Docker 安装前设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"></span><br><span class="line">curl -fsSL https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;ubuntu&#x2F;gpg | apt-key add -</span><br><span class="line"></span><br><span class="line">add-apt-repository &quot;deb [arch&#x3D;amd64] https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;ubuntu $(lsb_release -cs) stable&quot; apt-get update</span><br></pre></td></tr></table></figure>

<p>删除已经存在的低版本 Docker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get purge docker-ce docker docker-engine docker.io  &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;docker</span><br><span class="line"></span><br><span class="line">apt-get autoremove docker-ce docker docker-engine docker.io</span><br></pre></td></tr></table></figure>

<p>安装指定版本的 Docker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y docker-ce&#x3D;18.06.3~ce~3-0~ubuntu</span><br></pre></td></tr></table></figure>

<p>启动 Docker 并设置开机自重启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure>

<p>安装好 Docker 后，需要配置一下 Docker 以让其生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line"> &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line"> &quot;log-opts&quot;: &#123;</span><br><span class="line">   &quot;max-size&quot;: &quot;100m&quot;,</span><br><span class="line">   &quot;max-file&quot;: &quot;10&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;insecure-registries&quot;: [&quot;http:&#x2F;&#x2F;k8s.gcr.io&quot;],</span><br><span class="line"> &quot;data-root&quot;: &quot;&quot;,</span><br><span class="line"> &quot;default-runtime&quot;: &quot;nvidia&quot;,</span><br><span class="line"> &quot;runtimes&quot;: &#123;</span><br><span class="line">     &quot;nvidia&quot;: &#123;</span><br><span class="line">         &quot;path&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;nvidia-container-runtime&quot;,</span><br><span class="line">         &quot;runtimeArgs&quot;: []</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是含 GPU 的配置，如果你的机器不含 GPU，可按照下面来配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;registry-mirrors&quot;:[</span><br><span class="line">&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;</span><br><span class="line">],</span><br><span class="line">&quot;storage-driver&quot;:&quot;overlay2&quot;,</span><br><span class="line">&quot;log-driver&quot;:&quot;json-file&quot;,</span><br><span class="line">&quot;log-opts&quot;:&#123;</span><br><span class="line">&quot;max-size&quot;:&quot;100m&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;exec-opts&quot;:[</span><br><span class="line">&quot;native.cgroupdriver&#x3D;systemd&quot;</span><br><span class="line">],</span><br><span class="line">&quot;insecure-registries&quot;:[&quot;http:&#x2F;&#x2F;k8s.gcr.io&quot;],</span><br><span class="line">&quot;live-restore&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们重启 Docker 服务并设置开机自动重启，重启后可以看到 Docker 的相关信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; docker info</span><br></pre></td></tr></table></figure>

<h4 id="安装-K8s"><a href="#安装-K8s" class="headerlink" title="安装 K8s"></a>安装 K8s</h4><p>在安装 K8s 之前，我们需要设置一下环境，以便很快的拉取相关的镜像，这里选择了阿里源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class="line"></span><br><span class="line">curl -s https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt&#x2F;doc&#x2F;apt-key.gpg | apt-key add -</span><br><span class="line"></span><br><span class="line">tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;kubernetes.list &lt;&lt;-&#39;EOF&#39;</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;apt kubernetes-xenial main</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>配置完阿里源后，我们更新一下资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<p>更新完后，先摒弃不可用或损坏的 K8s 组件 kubectl、kubeadm、kubelet 的残留：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get purge kubelet&#x3D;1.13.5-00 kubeadm&#x3D;1.13.5-00 kubectl&#x3D;1.13.5-00</span><br><span class="line">apt-get autoremove kubelet&#x3D;1.13.5-00 kubeadm&#x3D;1.13.5-00 kubectl&#x3D;1.13.5-00</span><br></pre></td></tr></table></figure>

<p>重新更新、安装一份指定版本的 K8s 组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y kubelet&#x3D;1.13.5-00 kubeadm&#x3D;1.13.5-00 kubectl&#x3D;1.13.5-00</span><br><span class="line">apt-mark hold kubelet&#x3D;1.13.5-00 kubeadm&#x3D;1.13.5-00 kubectl&#x3D;1.13.5-00</span><br></pre></td></tr></table></figure>

<p>这里的三大组件 kubectl、kubeadm、kubelet，都是比较重要的，下面简单介绍下：</p>
<ul>
<li>kubectl 是 K8s 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。</li>
<li>kubeadm 是部署、安装 K8s 的一种命令工具。它提供了 <code>kubeadm init</code> 以及 <code>kubeadm join</code> 这两个命令作为快速创建 Kubernetes 集群的最佳实践。</li>
<li>关于 kubelet，在 K8s 集群中，在每个 Node 上都会启动一个 kubelet 服务的进程。该进程用于处理 Master 下发到本节点的任务，管理 Pod 及 Pod 中的容器。每个 kubelet 进程都会在 API Server 上注册节点自身的信息，定期向 Master 汇报节点资源的使用情况，并通过 cAdvisor 监控容器和节点资源。</li>
</ul>
<p>接下来启动服务并设置开机自动重启:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet &amp;&amp; sudo systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p>组件安装好了，接下来安装 K8s 相关镜像，由于 gcr.io 网络访问不了，从 registry.cn-hangzhou.aliyuncs.com 镜像地址下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-apiserver:v1.13.5</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-controller-manager:v1.13.5</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-scheduler:v1.13.5</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-proxy:v1.13.5</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;pause:3.1</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;etcd:3.2.24</span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;coredns:1.2.6</span><br></pre></td></tr></table></figure>

<p>注意：每个镜像的版本要注意，而且对应的 CoreDNS、Etcd 版本也要对应，每个版本的 K8s 对应的不一样的。否则，可能会出问题的。</p>
<p>拉取镜像后，我们需要打标签，因为 <code>kubeadm init</code> 的时候，标签是固定的，具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-apiserver:v1.13.5 k8s.gcr.io&#x2F;kube-apiserver:v1.13.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-controller-manager:v1.13.5 k8s.gcr.io&#x2F;kube-controller-manager:v1.13.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-scheduler:v1.13.5 k8s.gcr.io&#x2F;kube-scheduler:v1.13.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;gg-gcr-io&#x2F;kube-proxy:v1.13.5 k8s.gcr.io&#x2F;kube-proxy:v1.13.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;pause:3.1 k8s.gcr.io&#x2F;pause:3.1</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;etcd:3.2.24 k8s.gcr.io&#x2F;etcd:3.2.24</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;kuberimages&#x2F;coredns:1.2.6 k8s.gcr.io&#x2F;coredns:1.2.6</span><br></pre></td></tr></table></figure>

<h4 id="kubeadm-初始化"><a href="#kubeadm-初始化" class="headerlink" title="kubeadm 初始化"></a>kubeadm 初始化</h4><p>上面的操作步骤走完后，接下来就是利用 kubeadm 初始化 K8s，其中主机 IP 根据自己的实际情况输入，通过 <code>kubeadm init [flags]</code> 形式可以启动一个 master 节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --kubernetes-version&#x3D;v1.13.5 --pod-network-cidr&#x3D;10.244.0.0&#x2F;16 --service-cidr&#x3D;10.16.0.0&#x2F;16 --apiserver-advertise-address&#x3D;$&#123;masterIp&#125; | tee kubeadm-init.log</span><br></pre></td></tr></table></figure>

<p>此时，如果未知主机 IP，也可利用 yaml 文件动态初始化，我们通过 hosts 来进行动态加载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;hosts</span><br><span class="line">10.10.5.100 k8s.api.server</span><br><span class="line"></span><br><span class="line">vi kube-init.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: kubeadm.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5</span><br><span class="line">imageRepository: registry.aliyuncs.com&#x2F;google_containers</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - &quot;k8s.api.server&quot;</span><br><span class="line">controlPlaneEndpoint: &quot;k8s.api.server:6443&quot;</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: &quot;10.1.0.0&#x2F;16&quot;</span><br><span class="line">  podSubnet: &quot;10.244.0.0&#x2F;16&quot;</span><br></pre></td></tr></table></figure>

<p>设置 Etcd HA 版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5</span><br><span class="line">imageRepository: registry.aliyuncs.com&#x2F;google_containers</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - &quot;api.k8s.com&quot;</span><br><span class="line">controlPlaneEndpoint: &quot;api.k8s.com:6443&quot;</span><br><span class="line">etcd:</span><br><span class="line">    external:</span><br><span class="line">        endpoints:</span><br><span class="line">        - https:&#x2F;&#x2F;ETCD_0_IP:2379</span><br><span class="line">        - https:&#x2F;&#x2F;ETCD_1_IP:2379</span><br><span class="line">        - https:&#x2F;&#x2F;ETCD_2_IP:2379</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: 10.1.0.0&#x2F;16</span><br><span class="line">  podSubnet: 10.244.0.0&#x2F;16</span><br></pre></td></tr></table></figure>

<p>注意：apiVersion 中用 kubeadm，因为需要用 kubeadm 来初始化，最后执行下面来初始化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config&#x3D;kube-init.yaml</span><br></pre></td></tr></table></figure>

<p>请耐心等几分钟直到结束。</p>
<p>出现问题，解决后，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<p>如果需要更多，可执行下面来查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm --help</span><br></pre></td></tr></table></figure>

<p>部署如果没问题，查看当前的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubelet --version</span><br></pre></td></tr></table></figure>

<h4 id="部署出现问题"><a href="#部署出现问题" class="headerlink" title="部署出现问题"></a>部署出现问题</h4><p>先删除 node 节点（集群版）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</span><br><span class="line"></span><br><span class="line">kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure>

<p>清空 init 配置在需要删除的节点上执行（注意，当执行 init 或者 join 后出现任何错误，都可以使用此命令返回）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<h4 id="查问题"><a href="#查问题" class="headerlink" title="查问题"></a>查问题</h4><p>初始化后出现问题，可以通过以下命令先查看其容器状态以及网络情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a | grep kube | grep -v pause</span><br><span class="line"></span><br><span class="line">sudo docker logs CONTAINERID</span><br><span class="line"></span><br><span class="line">sudo docker images &amp;&amp; systemctl status -l kubelet</span><br><span class="line"></span><br><span class="line">netstat -nlpt</span><br><span class="line"></span><br><span class="line">kubectl describe ep kubernetes</span><br><span class="line"></span><br><span class="line">kubectl describe svc kubernetes</span><br><span class="line"></span><br><span class="line">kubectl get svc kubernetes</span><br><span class="line"></span><br><span class="line">kubectl get ep</span><br><span class="line"></span><br><span class="line">netstat -nlpt | grep apiser</span><br><span class="line"></span><br><span class="line">vi &#x2F;var&#x2F;log&#x2F;syslog</span><br></pre></td></tr></table></figure>

<h4 id="给当前用户配置-K8s-apiserver-访问公钥"><a href="#给当前用户配置-K8s-apiserver-访问公钥" class="headerlink" title="给当前用户配置 K8s apiserver 访问公钥"></a>给当前用户配置 K8s apiserver 访问公钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p $HOME&#x2F;.kube</span><br><span class="line"></span><br><span class="line">sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></figure>

<h4 id="网络插件"><a href="#网络插件" class="headerlink" title="网络插件"></a>网络插件</h4><p>在上面的步骤后，如果查看节点情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p>查看 nodes 状态信息，看到 node 节点的状态为 NotReady，这是因为缺少容器网络的配置。</p>
<p>接下来需要部署网络插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;v3.3&#x2F;getting-started&#x2F;kubernetes&#x2F;installation&#x2F;hosted&#x2F;rbac-kdd.yaml</span><br><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;v3.3&#x2F;getting-started&#x2F;kubernetes&#x2F;installation&#x2F;hosted&#x2F;kubernetes-datastore&#x2F;calico-networking&#x2F;1.7&#x2F;calico.yaml</span><br><span class="line"></span><br><span class="line">vi calico.yaml</span><br><span class="line"></span><br><span class="line">- name: CALICO_IPV4POOL_IPIP</span><br><span class="line"> value:&quot;off&quot;</span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line"> value: &quot;10.244.0.0&#x2F;16</span><br><span class="line"></span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>

<p>单机下允许 master 节点部署 pod 命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io&#x2F;master-</span><br></pre></td></tr></table></figure>

<p>禁止 master 部署 pod：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes k8s node-role.kubernetes.io&#x2F;master&#x3D;true:NoSchedule</span><br></pre></td></tr></table></figure>

<p>以上单机版部署结束，如果你的项目中，交付的是软硬件结合的一体机，那么到此就结束了。记得单机下要允许 master 节点部署哟！</p>
<h3 id="K8s-集群版实战"><a href="#K8s-集群版实战" class="headerlink" title="K8s 集群版实战"></a>K8s 集群版实战</h3><p>以上面部署的机器为例，作为 master 节点，我们备份一些配置到节点机器，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scp &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $nodeUser@$nodeIp:&#x2F;home&#x2F;$nodeUser</span><br><span class="line"></span><br><span class="line">scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;* $nodeUser@$nodeIp:&#x2F;home&#x2F;$nodeUser&#x2F;etcd</span><br><span class="line"></span><br><span class="line">kubeadm token generate</span><br><span class="line"></span><br><span class="line">kubeadm token create $token_name --print-join-command --ttl&#x3D;0</span><br><span class="line"></span><br><span class="line">kubeadm join $masterIP:6443 --token  $token_name --discovery-token-ca-cert-hash $hash</span><br></pre></td></tr></table></figure>

<p>注意，这个 token 24 小时后会失效，如果后面有其他节点要加入的话，处理方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token generate</span><br><span class="line"></span><br><span class="line">kubeadm token list</span><br><span class="line"></span><br><span class="line">openssl x509 -pubkey -in &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt | openssl rsa -pubin -outform der 2&gt;&#x2F;dev&#x2F;null | openssl dgst -sha256 -hex | sed &#39;s&#x2F;^.* &#x2F;&#x2F;&#39;</span><br></pre></td></tr></table></figure>

<p>然后拿到 token 和一个 sha256 密钥后执行下面即可加入集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join $masterIP:6443 --token  $token_name --discovery-token-ca-cert-hash $hash</span><br></pre></td></tr></table></figure>

<p>Node 机器执行时，如果需要 Cuda，可以参考以下资料：</p>
<ul>
<li><a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#ubuntu-installation" target="_blank" rel="noopener">https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#ubuntu-installation</a></li>
<li><a href="https://blog.csdn.net/u012235003/article/details/54575758" target="_blank" rel="noopener">https://blog.csdn.net/u012235003/article/details/54575758</a></li>
<li><a href="https://blog.csdn.net/qq_39670011/article/details/90404111" target="_blank" rel="noopener">https://blog.csdn.net/qq_39670011/article/details/90404111</a></li>
</ul>
<p>正式执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;modprobe.d&#x2F;blacklist-nouveau.conf</span><br><span class="line"></span><br><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset&#x3D;0</span><br><span class="line">update-initramfs -u</span><br></pre></td></tr></table></figure>

<p>重启 Ubuntu 查看是否禁用成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep nouveau</span><br><span class="line"></span><br><span class="line">apt-get remove --purge nvidia*</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;developer.nvidia.com&#x2F;cuda-downloads</span><br><span class="line"></span><br><span class="line">sudo apt-get install freeglut3-dev build-essential libx11-dev libxmu-dev libxi-dev libgl1-mesa-glx libglu1-mesa libglu1-mesa-dev</span><br></pre></td></tr></table></figure>

<p>安装 Cuda：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">accept</span><br><span class="line"></span><br><span class="line">select &quot;Install&quot; &#x2F; Enter</span><br><span class="line"></span><br><span class="line">select &quot;Yes&quot;</span><br><span class="line"></span><br><span class="line">sh cuda_10.1.168_418.67_linux.run</span><br><span class="line"></span><br><span class="line">echo &#39;export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;cuda-10.1&#x2F;bin:$PATH&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">echo &#39;export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;cuda-10.1&#x2F;NsightCompute-2019.3:$PATH&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">echo &#39;export LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;cuda-10.1&#x2F;lib64:$LD_LIBRARY_PATH&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">source ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<p>重启机器，检查 Cuda 是否安装成功。</p>
<p>查看是否有 nvidia* 的设备：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;dev &amp;&amp; ls -al</span><br></pre></td></tr></table></figure>

<p>如果没有，创建一个 nv.sh：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vi nv.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash &#x2F;sbin&#x2F;modprobe nvidia</span><br><span class="line">if [ &quot;$?&quot; -eq 0 ];</span><br><span class="line">then</span><br><span class="line">NVDEVS&#x3D;&#96;lspci |</span><br><span class="line"> grep -i NVIDIA</span><br><span class="line">&#96;</span><br><span class="line">N3D&#x3D;&#96;</span><br><span class="line">echo</span><br><span class="line">&quot;$NVDEVS&quot;</span><br><span class="line">| grep &quot;3D controller&quot; |</span><br><span class="line"> wc -l</span><br><span class="line">&#96;</span><br><span class="line">NVGA&#x3D;&#96;</span><br><span class="line">echo</span><br><span class="line">&quot;$NVDEVS&quot;</span><br><span class="line">| grep &quot;VGA compatible controller&quot; |</span><br><span class="line"> wc -l</span><br><span class="line">&#96;</span><br><span class="line">N&#x3D;&#96;</span><br><span class="line">expr $N3D + $NVGA -</span><br><span class="line">1</span><br><span class="line">&#96;</span><br><span class="line">for i in &#96;</span><br><span class="line">seq</span><br><span class="line">0</span><br><span class="line"> $N</span><br><span class="line">&#96;; do</span><br><span class="line">    mknod -m 666 &#x2F;dev&#x2F;nvidia$i c 195 $i</span><br><span class="line">done</span><br><span class="line">    mknod -m 666 &#x2F;dev&#x2F;nvidiactl c 195 255</span><br><span class="line">else</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">chmod +x nv.sh &amp;&amp; bash nv.sh</span><br></pre></td></tr></table></figure>

<p>再次重启机器查看 Cuda 版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure>

<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;cuda-10.1&#x2F;samples &amp;&amp;  make</span><br><span class="line"></span><br><span class="line">cd  &#x2F;usr&#x2F;local&#x2F;cuda-10.1&#x2F;samples&#x2F;bin&#x2F;x86_64&#x2F;linux&#x2F;release .&#x2F;deviceQuery</span><br></pre></td></tr></table></figure>

<p>以上如果输出“Result = PASS”，代表 Cuda 安装成功。</p>
<p>安装 nvdocker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">&quot;runtimes&quot;:&#123;</span><br><span class="line">    &quot;nvidia&quot;:&#123;</span><br><span class="line">         &quot;path&quot;:&quot;nvidia-container-runtime&quot;,</span><br><span class="line">          &quot;runtimeArgs&quot;:[]</span><br><span class="line">     &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;],</span><br><span class="line">&quot;storage-driver&quot;:&quot;overlay2&quot;,</span><br><span class="line">&quot;default-runtime&quot;:&quot;nvidia&quot;,</span><br><span class="line">&quot;log-driver&quot;:&quot;json-file&quot;,</span><br><span class="line">&quot;log-opts&quot;:&#123;</span><br><span class="line"> &quot;max-size&quot;:&quot;100m&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],</span><br><span class="line">&quot;insecure-registries&quot;: [$harborRgistry],</span><br><span class="line">&quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启 Docker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker &amp;&amp; docker info</span><br></pre></td></tr></table></figure>

<p>检查 nvidia-docker 安装是否成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --runtime&#x3D;nvidia --rm nvidia&#x2F;cuda:9.0-base nvidia-smi</span><br></pre></td></tr></table></figure>

<p>在节点机器进入 su 模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su $nodeUser</span><br></pre></td></tr></table></figure>

<p>给当前节点用户配置 K8s apiserver 访问公钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME&#x2F;.kube</span><br><span class="line"></span><br><span class="line">cp -i  admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">mkdir -p $HOME&#x2F;etcd</span><br><span class="line"></span><br><span class="line">sudo rm -rf &#x2F;etc&#x2F;kubernetes</span><br><span class="line"></span><br><span class="line">sudo mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</span><br><span class="line"></span><br><span class="line">sudo cp &#x2F;home&#x2F;$nodeUser&#x2F;etcd&#x2F;* &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</span><br><span class="line"></span><br><span class="line">sudo kubeadm join $masterIP:6443 --token  $token_name --discovery-token-ca-cert-hash $hash</span><br></pre></td></tr></table></figure>

<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join 192.168.8.116:6443 --token vyi4ga.foyxqr2iz9i391q3 --discovery-token-ca-cert-hash sha256:929143bcdaa3e23c6faf20bc51ef6a57df02edf9df86cedf200320a9b4d3220a</span><br></pre></td></tr></table></figure>

<p>检查 node 是否加入 master：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;到此，K8s 单机、集群版部署流程就结束了，后面我们会将 K8s 与微服务结合一起来分析 K8s 的组件的特性。</p>
<h6 id="5-3-Kubernetes-的组件及负载均衡"><a href="#5-3-Kubernetes-的组件及负载均衡" class="headerlink" title="5.3 Kubernetes 的组件及负载均衡"></a>5.3 Kubernetes 的组件及负载均衡</h6><p>&emsp;&emsp;上面介绍了 K8s 的由来、概念以及特性，接下来，我们看看 K8s 的组件。K8s 的组件分为 Master 组件、Node 组件。</p>
<h5 id="Master-组件"><a href="#Master-组件" class="headerlink" title="Master 组件"></a>Master 组件</h5><p>1、kube-apiserver</p>
<p>&emsp;&emsp;Kubernetes API 服务器的主要实现是 kube-apiserver。 kube-apiserver 设计上考虑了水平伸缩，也就是说，它可通过部署多个实例进行伸缩。 你可以运行 kube-apiserver 的多个实例，并在这些实例之间平衡流量。</p>
<p>2、etcd</p>
<p>&emsp;&emsp;etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。通常，集群的 etcd 数据库通常需要有个备份计划。</p>
<p>3、kube-controller-manager</p>
<p>&emsp;&emsp;在主节点上运行控制器的组件。</p>
<p>4、cloud-controller-manager</p>
<p>&emsp;&emsp;cloud-controller-manager 仅运行特定于云平台的控制回路。 如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境， 所部署的环境中不需要云控制器管理器。</p>
<p>5、kube-scheduler</p>
<p>&emsp;&emsp;控制平面组件，负责监视新创建的、未指定运行节点（node）的 Pods，选择节点让 Pod 在上面运行。调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件/软件/策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后时限。</p>
<h5 id="Node-组件"><a href="#Node-组件" class="headerlink" title="Node 组件"></a>Node 组件</h5><p>&emsp;&emsp;节点组件在每个节点上运行，维护运行的 Pod 并提供 Kubernetes 运行环境。如果 Master 也被设置允许为工作节点，则节点组件同样运行在 Master 上。</p>
<p>1、kubelet</p>
<p>&emsp;&emsp;一个在集群中每个节点（node）上运行的代理。 它保证容器（containers）都 运行在 Pod 中。</p>
<p>2、kube-proxy</p>
<p>&emsp;&emsp;kube-proxy 是集群中每个节点上运行的网络代理， 实现 Kubernetes 服务（Service） 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。</p>
<ul>
<li>1.kube-proxy 主要是处理集群外部通过 nodePort 访问集群内服务，通过 iptables 规则，解析 cluterIP 到 PodIp 的过程，并提供服务的负载均衡能力。</li>
<li>2.kube-proxy 还可以提供集群内部服务间通过 clusterIP 访问，也会经过 kube-proxy 负责转发。</li>
<li>3.kube-dns 主要在 Pod 内通过 serviceName 访问其他服务，找到服务对应的 clusterIP 的关系，和一些基本的域名解析功能。</li>
<li>4.kube-dns 是和 kube-proxy 协同工作的，前者通过 servicename 找到指定 clusterIP，后者完成通过 clusterIP 到 PodIP 的过程。</li>
<li>这里，K8s 通过虚拟出一个集群 IP，利用 kube-proxy 为 service 提供 cluster 内的服务发现和负载均衡。</li>
</ul>
<p>3、Container Runtime</p>
<p>&emsp;&emsp;容器运行环境是负责运行容器的软件。Kubernetes 支持多个容器运行环境: Docker、 containerd、CRI-O 以及任何实现 Kubernetes CRI (容器运行环境接口)。</p>
<p>4、插件 Addons</p>
<p>&emsp;&emsp;插件使用 Kubernetes 资源（DaemonSet、 Deployment 等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于 kube-system 命名空间。</p>
<p>5、DNS</p>
<p>&emsp;&emsp;尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该 有集群 DNS， 因为很多示例都需要 DNS 服务。</p>
<p>6、Dashboard</p>
<p>&emsp;&emsp;Dashboard 是 Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身并进行故障排除。</p>
<p><img src="https://static001.geekbang.org/infoq/b5/b5662d4d56083e5a500dd73eb9d1244f.png" alt=""></p>
<h5 id="K8s如何实现服务注册与发现"><a href="#K8s如何实现服务注册与发现" class="headerlink" title="K8s如何实现服务注册与发现"></a>K8s如何实现服务注册与发现</h5><p>&emsp;&emsp;上面介绍了K8s的各种组件，接下来，我们看看K8s是如何实现服务的注册与发现，然后如何做到服务的转发、实现负载均衡的能力。</p>
<p>&emsp;&emsp;服务在K8s中，也定义了一种资源：Service，Service，顾名思义是一个服务，什么样的服务呢？它是定义了一个服务的多种 pod 的逻辑合集以及一种访问 pod 的策略。</p>
<p>service 的类型有四种：</p>
<ul>
<li>ExternalName：创建一个 DNS 别名指向 service name，这样可以防止 service name 发生变化，但需要配合 DNS 插件使用。</li>
<li>ClusterIP：默认的类型，用于为集群内 Pod 访问时，提供的固定访问地址,默认是自动分配地址,可使用 ClusterIP 关键字指定固定 IP。</li>
<li>NodePort：基于 ClusterIp，用于为集群外部访问 Service 后面 Pod 提供访问接入端口。</li>
<li>LoadBalancer：它是基于 NodePort。</li>
</ul>
<p>从上面讲的 Service，我们可以看到一种场景：所有的微服务在一个局域网内，或者说在一个 K8s 集群下，那么可以通过 Service 用于集群内 Pod 的访问，这就是 Service 默认的一种类型 ClusterIP，ClusterIP 这种的默认会自动分配地址。</p>
<p>&emsp;&emsp;那么问题来了，既然可以通过上面的 ClusterIp 来实现集群内部的服务访问，那么如何注册服务呢？其实 K8s 并没有引入任何的注册中心，使用的就是 K8s 的 kube-dns 组件。然后 K8s 将 Service 的名称当做域名注册到 kube-dns 中，每一个Service在kube-dns中都有一条DNS记录，同时，如果有服务的ip更换，kube-dns自动会同步，对服务来说是不需要改动的。通过 Service 的名称就可以访问其提供的服务。那么问题又来了，如果一个服务的 pod 对应有多个，那么如何实现 LB？其实，最终通过 kube-proxy，实现负载均衡。也就是说kube-dns通过 servicename 找到指定 clusterIP，kube-proxy完成通过 clusterIP 到 PodIP 的过程。</p>
<p>说到这，我们来看下 Service 的服务发现与负载均衡的策略，Service 负载分发策略有两种：</p>
<ul>
<li>RoundRobin：轮询模式，即轮询将请求转发到后端的各个 pod 上，其为默认模式。</li>
<li>SessionAffinity：基于客户端 IP 地址进行会话保持的模式，类似 IP Hash 的方式，来实现服务的负载均衡。</li>
</ul>
<p>下面写一个很简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: cas-server-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: cas-server01</span><br><span class="line">    port: 2000</span><br><span class="line">    targetPort: cas-server01</span><br><span class="line">  selector:</span><br><span class="line">    app: cas-server</span><br></pre></td></tr></table></figure>

<p>可以看到执行 kubectl apply -f service.yaml 后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~$ kubectl get svc</span><br><span class="line">NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE</span><br><span class="line">admin-web-service             ClusterIP   10.16.129.24    &lt;none&gt;        2001&#x2F;TCP              84d</span><br><span class="line">cas-server-service            ClusterIP   10.16.230.167   &lt;none&gt;        2000&#x2F;TCP               67d</span><br><span class="line">cloud-admin-service-service   ClusterIP   10.16.25.178    &lt;none&gt;        1001&#x2F;TCP         190d</span><br></pre></td></tr></table></figure>

<p>这样，我们可以看到默认的类型是 ClusterIP，用于为集群内 Pod 访问时，可以先通过域名来解析到多个服务地址信息，然后再通过 LB 策略来选择其中一个作为请求的对象。</p>
<h5 id="K8s-如何处理微服务中常用的配置"><a href="#K8s-如何处理微服务中常用的配置" class="headerlink" title="K8s 如何处理微服务中常用的配置"></a>K8s 如何处理微服务中常用的配置</h5><p>&emsp;&emsp;接下来我们看看微服务中场景的居多配置该如何来利用K8s实现统一管理。其实，在K8s中，定义了一种资源：ConfigMap，我们来看看这种资源。</p>
<p>&emsp;&emsp;ConfigMap，看到这个名字可以理解：它是用于保存配置信息的键值对，可以用来保存单个属性，也可以保存配置文件。对于一些非敏感的信息，比如应用的配置信息，则可以使用 ConfigMap。</p>
<p>创建一个 ConfigMap 有多种方式如下。</p>
<ol>
<li><p>key-value 字符串创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap test-config --from-literal&#x3D;baseDir&#x3D;&#x2F;usr</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上面的命令创建了一个名为 test-config，拥有一条 key 为 baseDir，value 为 “/usr” 的键值对数据。</p>
</li>
<li><p>根据 yml 描述文件创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: test-config</span><br><span class="line">data:</span><br><span class="line">  baseDir: &#x2F;usr</span><br></pre></td></tr></table></figure>
<p>也可以这样，创建一个 yml 文件，选择不同的环境配置不同的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cas-server</span><br><span class="line">data:</span><br><span class="line">  application.yaml: |-</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the World</span><br><span class="line">    ---</span><br><span class="line">    spring:</span><br><span class="line">      profiles: dev</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Dev</span><br><span class="line">    spring:</span><br><span class="line">      profiles: test</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Test</span><br><span class="line">    spring:</span><br><span class="line">      profiles: prod</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Prod</span><br></pre></td></tr></table></figure>
<p>注意点：</p>
</li>
</ol>
<ul>
<li>ConfigMap 必须在 Pod 使用其之前创建。</li>
<li>Pod 只能使用同一个命名空间的 ConfigMap。</li>
</ul>
<p>&emsp;&emsp;当然，还有其他更多用途，具体可以参考官网(<a href="https://kubernetes.io/zh/docs/concepts/configuration/configmap/)。" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/configuration/configmap/)。</a></p>
<p>前面讲述了几种创建ConfigMap的方式，其中有一种在 Java 中常常用到：通过创建 yml 文件来实现配置管理。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cas-server</span><br><span class="line">data:</span><br><span class="line">  application.yaml: |-</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the World</span><br><span class="line">    ---</span><br><span class="line">    spring:</span><br><span class="line">      profiles: dev</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Dev</span><br><span class="line">    spring:</span><br><span class="line">      profiles: test</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Test</span><br><span class="line">    spring:</span><br><span class="line">      profiles: prod</span><br><span class="line">    greeting:</span><br><span class="line">      message: Say Hello to the Prod</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这样，当我们启动容器时，通过 –spring.profiles.active=dev 来指定当前容器的活跃环境，即可获取 ConfigMap 中对应的配置。是不是感觉跟 Java 中的 Config 配置多个环境的配置有点类似呢？但是，我们不用那么复杂，这些统统可以交给 K8s 来处理。只需要你启动这一命令即可，是不是很简单？</p>
<h5 id="第六章-为什么选择-Kubernetes-1"><a href="#第六章-为什么选择-Kubernetes-1" class="headerlink" title="第六章 为什么选择 Kubernetes"></a>第六章 为什么选择 Kubernetes</h5><h6 id="6-1-Kubernetes-与微服务的天生绝配-1"><a href="#6-1-Kubernetes-与微服务的天生绝配-1" class="headerlink" title="6.1 Kubernetes 与微服务的天生绝配"></a>6.1 Kubernetes 与微服务的天生绝配</h6><p>&emsp;&emsp;其实，为什么我们需要 K8s，它到底能做什么呢？</p>
<p>&emsp;&emsp;容器是打包和运行应用程序的好方式。在生产环境中，你需要管理运行应用程序的容器，并确保不会停机。 例如，如果一个容器发生故障，则需要启动另一个容器。如果系统处理此行为，会不会更容易？这就是 Kubernetes 来解决这些问题的方法！ Kubernetes 为你提供了一个可弹性运行分布式系统的框架。 Kubernetes 会满足你的扩展要求、故障转移、部署模式等。 例如，Kubernetes 可以轻松管理系统的 Canary 部署。</p>
<p>Kubernetes 会提供：</p>
<ul>
<li>服务发现和负载均衡，Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</li>
<li>自动部署和回滚，你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态更改为期望状态。例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</li>
<li>自我修复，Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</li>
<li>存储编排，Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</li>
<li>自动完成装箱计算，Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）。 当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</li>
<li>密钥与配置管理，Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</li>
</ul>
<p>&emsp;&emsp;那么对于 K8s 提供的这些功能，其实对于微服务来讲，都是很好的一个平台提供。换句话说，对于微服务来说，如果使用 K8s 的话，可以不用考虑语言上的限制，更不用考虑各种开发语言的框架的限制；对于各种语言来说，在前面也介绍过，都有很多不同的框架，那如果运用这些框架时，就需要考虑不同服务之间如果属于不同的语言，那么该如何来实现微服务的架构呢？从这一角度来分析，微服务与 K8s 属于天作之合，它们的结合可以说是天衣无缝、完美至极。在后面章节中，将会介绍它们的天衣无缝：自治与无缝迁移。</p>
<h6 id="6-2-基于-Kubernetes-集群的服务治理-1"><a href="#6-2-基于-Kubernetes-集群的服务治理-1" class="headerlink" title="6.2 基于 Kubernetes 集群的服务治理"></a>6.2 基于 Kubernetes 集群的服务治理</h6><p>&emsp;&emsp;其实，做微服务架构设计，我们希望得到什么呢？看下图：<br><img src="https://static001.geekbang.org/infoq/5c/5c17301931632913b47422c2262931c4.png" alt=""></p>
<p>&emsp;&emsp;从上面这张图中可以看到，微服务的解耦、封装，从而简化开发人员的开发。调用方便，主要体现在sdk或者说client的提供者很容易被调用，这就体现了K8s的服务注册与发现。安全性考虑，基于K8s集群的保障，可以让微服务们处于一个堡垒中，这样避免外部的干扰。同时，服务之间直接走内部网络，可以大大提升性能。</p>
<p>&emsp;&emsp;说到这些，其实服务的自动化才是一个重点，自治能力体现了系统的健壮性。在前面章节中说到了K8s具有自动修复的能力，可以将失败或出现问题的容器进行重新编排、启动。容器本身的健康检查会被监视，当不响应用户定义的运行检查的容器就会被杀死。</p>
<p>&emsp;&emsp;同时，K8s提供自动部署能力，可以通过简单的命令来执行即可发挥K8s的作用。同时，K8s会根据用户的节点选择，将pod分配到对应的节点，这样对于运维人员来说，即使出现节点宕机，pod可以迅速的在其他节点被启动。</p>
<h6 id="6-3-基于-Kubernetes-的服务无缝迁移-1"><a href="#6-3-基于-Kubernetes-的服务无缝迁移-1" class="headerlink" title="6.3 基于 Kubernetes 的服务无缝迁移"></a>6.3 基于 Kubernetes 的服务无缝迁移</h6><p>&emsp;&emsp;在K8s集群中的服务，如果想要被迁移到其他的机器或其他集群。在传统的实现中，可能需要考虑到很多点：服务包的转移、共享，配置的转移，数据库的转移等等。但对于容器化来说，这些都被打包成image，而这些image可以被上传到一个仓库Habor，当需要迁移环境的时候，这些服务的镜像其实都可以不动，运维人员将要做的是：将开发人员编写的基于K8s的yaml文件在对应的集群中进行部署即可。运维人员无需关心任何其他事情，只需要在部署前，将需要的相关配置处理好即可。这将大大减少开发人员、运维的成本，让他们专注于部署，而不用关心其他的琐碎的事情。因为K8s是可以跨平台、跨系统的。主要存在K8s集群，服务都可以无缝的进行迁移过去。这也是微服务基于K8s的一个优势。下图为K8s基于Habor的架构图。</p>
<p><img src="https://static001.geekbang.org/infoq/e8/e847a9866cc308fc964fad04cd808c16.png" alt=""></p>
<ul>
<li>通过kubectl命令工具发起资源创建kubectl create -f xxx.yaml</li>
<li>k8s处理相关请求后kube-scheduler服务为pod寻找一个合适的“家”node2并创建pod。</li>
<li>node2上的kubelet处理相关资源，使用docker拉取相关镜像并运行。</li>
</ul>
<p>&emsp;&emsp;从上面的流程操作来看，将微服务从一个K8s集群，迁移到另一个集群，其操作是可以无缝对接的，可以同配置、同环境参数的无缝的迁移，这就是云原生下K8s带来的优势。也是需要企业现在一直推荐属性docker、K8s等技术的一个关键性要素。</p>
<h5 id="第七章-第一个基于-K8s-的多语言微服务架构-1"><a href="#第七章-第一个基于-K8s-的多语言微服务架构-1" class="headerlink" title="第七章 第一个基于 K8s 的多语言微服务架构"></a>第七章 第一个基于 K8s 的多语言微服务架构</h5><h6 id="7-1-基于-K8s-的-Java-微服务-1"><a href="#7-1-基于-K8s-的-Java-微服务-1" class="headerlink" title="7.1 基于 K8s 的 Java 微服务"></a>7.1 基于 K8s 的 Java 微服务</h6><p>&emsp;&emsp;前面很多的都是在说K8s为什么可以实现配置化，为什么可以提供负载均衡能力，接下来，我们举个电商系统来实现体验下K8s带来的效果，手写Java代码。</p>
<p>&emsp;&emsp;如下图，我们简单的画了一个系统图，从客户端到网关，再到订单服务、后台管理系统以及鉴权中心的流程。<br><img src="https://static001.geekbang.org/infoq/36/36548234c9acc7889fc9fd12fb0866e8.png" alt=""></p>
<h5 id="认证中心"><a href="#认证中心" class="headerlink" title="认证中心"></a>认证中心</h5><p>&emsp;&emsp;基于Java现在许多比较流行的框架，作者选择了SpringCloud，因为很多基础特性SpringCloud都具备了，接下来我们看如何实现鉴权。</p>
<p>环境：</p>
<ul>
<li>Ubuntu 16.04</li>
<li>Docker 18.06</li>
<li>K8s 1.13.5</li>
<li>springboot 2.3.8.RELEASE</li>
<li>springcloud Hoxton.SR9</li>
</ul>
<p>首先新建一个Java项目：</p>
<p><img src="https://static001.geekbang.org/infoq/35/35b9ebb2d04125500128008d6f41a50f.png" alt=""></p>
<p>引入依赖配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-actuator-autoconfigure&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-kubernetes-config&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.9.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.hutool&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hutool-all&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.6.3&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.guava&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;guava&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;19.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-lang3&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-collections&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.2.2&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- mybatis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.mybatis.spring.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mybatis-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.1.1&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;$&#123;mysql.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- datasource pool--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.3&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>新建服务启动类：</p>
<p><img src="https://static001.geekbang.org/infoq/ef/ef481f8fb27ab610a568214f61f0cb2e.png" alt=""></p>
<p>常见的配置文件bootstrap.yml、application.yml，主要是配置服务启动时，需要加载的参数、配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  endpoint:</span><br><span class="line">    restart:</span><br><span class="line">      enabled: true</span><br><span class="line">    health:</span><br><span class="line">      enabled: true</span><br><span class="line">    info:</span><br><span class="line">      enabled: true</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cas-server</span><br><span class="line">  cloud:</span><br><span class="line">    kubernetes:</span><br><span class="line">      config:</span><br><span class="line">        sources:</span><br><span class="line">         - name: $&#123;spring.application.name&#125;</span><br><span class="line">           namespace: system-server</span><br><span class="line">      discovery:</span><br><span class="line">        all-namespaces: true</span><br><span class="line">      reload:</span><br><span class="line">        #自动更新配置的开关设置为打开</span><br><span class="line">        enabled: true</span><br><span class="line">        #更新配置信息的模式：polling是主动拉取，event是事件通知</span><br><span class="line">        mode: polling</span><br><span class="line">        #主动拉取的间隔时间是500毫秒</span><br><span class="line">        period: 500</span><br><span class="line"></span><br><span class="line">  redis: #redis相关配置</span><br><span class="line">    database: 8</span><br><span class="line">    host: 10.10.3.15 #localhost</span><br><span class="line">    port: 6379</span><br><span class="line">    password: xxxxx  #有密码时设置</span><br><span class="line">    jedis:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 8</span><br><span class="line">        max-idle: 8</span><br><span class="line">        min-idle: 0</span><br><span class="line">    timeout: 10000ms</span><br><span class="line"></span><br><span class="line">  http:</span><br><span class="line">    encoding:</span><br><span class="line">      charset: UTF-8</span><br><span class="line">      enabled: true</span><br><span class="line">      force: true</span><br><span class="line">  mvc:</span><br><span class="line">    throw-exception-if-no-handler-found: true</span><br><span class="line">  main:</span><br><span class="line">    allow-bean-definition-overriding: true</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  path: &#x2F;data&#x2F;$&#123;spring.application.name&#125;&#x2F;logs</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;第一个配置中，介绍了该服务的信息，以及springboot2结合K8s的一个特性：自动刷新、加载配置，该模式有两种：</p>
<ul>
<li>主动拉取：polling，每隔一定时间拉取，自定义设置。</li>
<li>事件通知，event</li>
</ul>
<p>&emsp;&emsp;这里主要用主动拉取模式。后面就是配置一些插件redis、日志配置。</p>
<p>&emsp;&emsp;第二个配置文件可以设置一些环境、mybatis配置以及设置http协议的超时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 2000</span><br><span class="line">  undertow:</span><br><span class="line">    accesslog:</span><br><span class="line">      enabled: false</span><br><span class="line">      pattern: combined</span><br><span class="line">  servlet:</span><br><span class="line">    session:</span><br><span class="line">      timeout: PT120M</span><br><span class="line"></span><br><span class="line">client:</span><br><span class="line">  http:</span><br><span class="line">    request:</span><br><span class="line">      connectTimeout: 8000</span><br><span class="line">      readTimeout: 30000</span><br><span class="line"></span><br><span class="line">mybatis:</span><br><span class="line">  mapperLocations: classpath:mapper&#x2F;*.xml</span><br><span class="line">  typeAliasesPackage: com.damon.*.model</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;由于我们可以设置<strong>spring.profiles.active=dev</strong>，所以可以设置几个不同环境的文件来设置日志的级别。当然，你也可以直接在启动服务时，设置参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- spring.profiles.active&#x3D;dev --logging.level.org.springframework.web&#x3D;INFO --logging.level.com.damon&#x3D;INFO</span><br></pre></td></tr></table></figure>

<p>到目前为止，一些基础配置都已经写完了，接下来，我们看看鉴权的核心逻辑了。首先我们来写一个认证服务器配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.core.env.Environment;</span><br><span class="line">import org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.builders.ClientDetailsServiceBuilder;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.builders.InMemoryClientDetailsServiceBuilder;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line">import org.springframework.security.oauth2.provider.error.WebResponseExceptionTranslator;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line">import com.damon.component.JwtTokenEnhancer;</span><br><span class="line">import com.damon.login.service.LoginService;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 认证服务器配置</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月13日 下午3:03:30</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableAuthorizationServer</span><br><span class="line">public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private LoginService loginService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    &#x2F;&#x2F;@Qualifier(&quot;jwtTokenStore&quot;)</span><br><span class="line">    @Qualifier(&quot;redisTokenStore&quot;)</span><br><span class="line">    private TokenStore tokenStore;</span><br><span class="line">    &#x2F;*@Autowired</span><br><span class="line">    private JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenEnhancer jwtTokenEnhancer;*&#x2F;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment env;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private WebResponseExceptionTranslator userOAuth2WebResponseExceptionTranslator;</span><br><span class="line"></span><br><span class="line">   &#x2F;* @Override</span><br><span class="line">    public void configure(AuthorizationServerEndpointsConfigurer endpoints) &#123;</span><br><span class="line">        TokenEnhancerChain enhancerChain &#x3D; new TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; delegates &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        delegates.add(jwtTokenEnhancer); &#x2F;&#x2F;配置JWT的内容增强器</span><br><span class="line">        delegates.add(jwtAccessTokenConverter);</span><br><span class="line">        enhancerChain.setTokenEnhancers(delegates);</span><br><span class="line">        endpoints.authenticationManager(authenticationManager)&#x2F;&#x2F;支持 password 模式</span><br><span class="line">                .userDetailsService(loginService)</span><br><span class="line">                .tokenStore(tokenStore) &#x2F;&#x2F;配置令牌存储策略</span><br><span class="line">                .accessTokenConverter(jwtAccessTokenConverter)</span><br><span class="line">                .tokenEnhancer(enhancerChain);</span><br><span class="line">    &#125;*&#x2F;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * redis token 方式</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;</span><br><span class="line">    	&#x2F;&#x2F;验证时发生的情况处理</span><br><span class="line">        endpoints.authenticationManager(authenticationManager) &#x2F;&#x2F;支持 password 模式</span><br><span class="line">        		.exceptionTranslator(userOAuth2WebResponseExceptionTranslator)&#x2F;&#x2F;自定义异常处理类添加到认证服务器配置</span><br><span class="line">                .userDetailsService(loginService)</span><br><span class="line">                .tokenStore(tokenStore);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 客户端配置（给谁发令牌）</span><br><span class="line">     * 不同客户端配置不同</span><br><span class="line">     *</span><br><span class="line">     * authorizedGrantTypes 可以包括如下几种设置中的一种或多种：</span><br><span class="line">			authorization_code：授权码类型。需要redirect_uri</span><br><span class="line">			implicit：隐式授权类型。需要redirect_uri</span><br><span class="line">			password：资源所有者（即用户）密码类型。</span><br><span class="line">			client_credentials：客户端凭据（客户端ID以及Key）类型。</span><br><span class="line">			refresh_token：通过以上授权获得的刷新令牌来获取新的令牌。</span><br><span class="line"></span><br><span class="line">	   accessTokenValiditySeconds：token 的有效期</span><br><span class="line">	   scopes：用来限制客户端访问的权限，在换取的 token 的时候会带上 scope 参数，只有在 scopes 定义内的，才可以正常换取 token。</span><br><span class="line">     * @param clients</span><br><span class="line">     * @throws Exception</span><br><span class="line">     * @author Damon</span><br><span class="line">     * @date 2020年1月13日</span><br><span class="line">     *</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(&quot;admin-web&quot;)</span><br><span class="line">                .secret(passwordEncoder.encode(&quot;admin-web-123&quot;))</span><br><span class="line">                .accessTokenValiditySeconds(3600)</span><br><span class="line">                .refreshTokenValiditySeconds(864000)&#x2F;&#x2F;配置刷新token的有效期</span><br><span class="line">                .autoApprove(true) &#x2F;&#x2F;自动授权配置</span><br><span class="line">                .scopes(&quot;all&quot;)&#x2F;&#x2F;配置申请的权限范围</span><br><span class="line">                .authorizedGrantTypes(&quot;password&quot;, &quot;authorization_code&quot;, &quot;client_credentials&quot;, &quot;refresh_token&quot;)&#x2F;&#x2F;配置授权模式</span><br><span class="line">                .redirectUris(&quot;http:&#x2F;&#x2F;localhost:2001&#x2F;login&quot;)&#x2F;&#x2F;授权码模式开启后必须指定</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .withClient(&quot;order-service&quot;)</span><br><span class="line">                .secret(passwordEncoder.encode(&quot;order-service-123&quot;))</span><br><span class="line">                .accessTokenValiditySeconds(3600)</span><br><span class="line">                .refreshTokenValiditySeconds(864000)&#x2F;&#x2F;配置刷新token的有效期</span><br><span class="line">                .autoApprove(true) &#x2F;&#x2F;自动授权配置</span><br><span class="line">                .scopes(&quot;all&quot;)</span><br><span class="line">                .authorizedGrantTypes(&quot;password&quot;, &quot;authorization_code&quot;, &quot;client_credentials&quot;, &quot;refresh_token&quot;)&#x2F;&#x2F;配置授权模式</span><br><span class="line">                .redirectUris(&quot;http:&#x2F;&#x2F;localhost:2003&#x2F;login&quot;)&#x2F;&#x2F;授权码模式开启后必须指定</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .withClient(&quot;customer-service&quot;)</span><br><span class="line">                .secret(passwordEncoder.encode(&quot;customer-service-123&quot;))</span><br><span class="line">                .accessTokenValiditySeconds(3600)</span><br><span class="line">                .refreshTokenValiditySeconds(864000)&#x2F;&#x2F;配置刷新token的有效期</span><br><span class="line">                .autoApprove(true) &#x2F;&#x2F;自动授权配置</span><br><span class="line">                .scopes(&quot;all&quot;)</span><br><span class="line">                .authorizedGrantTypes(&quot;password&quot;, &quot;authorization_code&quot;, &quot;client_credentials&quot;, &quot;refresh_token&quot;)&#x2F;&#x2F;配置授权模式</span><br><span class="line">                .redirectUris(&quot;http:&#x2F;&#x2F;localhost:6000&#x2F;login&quot;)&#x2F;&#x2F;授权码模式开启后必须指定</span><br><span class="line">                ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configure(AuthorizationServerSecurityConfigurer security) &#123;</span><br><span class="line">    	security.allowFormAuthenticationForClients();&#x2F;&#x2F;是允许客户端访问 OAuth2 授权接口，否则请求 token 会返回 401</span><br><span class="line">    	security.checkTokenAccess(&quot;isAuthenticated()&quot;);&#x2F;&#x2F;是允许已授权用户访问 checkToken 接口</span><br><span class="line">        security.tokenKeyAccess(&quot;isAuthenticated()&quot;); &#x2F;&#x2F; security.tokenKeyAccess(&quot;permitAll()&quot;);获取密钥需要身份认证，使用单点登录时必须配置，是允许已授权用户获取 token 接口</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在这个配置中，我们redis来记录token，自定义了登录认证的逻辑LoginService，自定义异常处理类添加到认证服务器配置。同时函数<strong>configure</strong>加载了居多需要认证的客户端服务，配置了授权模式：”password”、”authorization_code”、”client_credentials”、”refresh_token”，配置刷新token的有效期。</p>
<p>&emsp;&emsp;我们先来看看自定义的认证逻辑，先来看看接口类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.login.service;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"></span><br><span class="line">import com.damon.commons.Response;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author  Damon</span><br><span class="line"> * @date 2018年11月15日 上午11:59:24</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public interface LoginService extends UserDetailsService &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 *</span><br><span class="line">	 * Spring Security默认函数</span><br><span class="line">	 * @param username</span><br><span class="line">	 * @return</span><br><span class="line">	 * @throws UsernameNotFoundException</span><br><span class="line">	 * @author Damon</span><br><span class="line">	 * @date 2020年1月13日</span><br><span class="line">	 *</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;以下自定义</span><br><span class="line"></span><br><span class="line">	Response&lt;Object&gt; login(String username, String password);</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 *</span><br><span class="line">	 * 校验token合法性</span><br><span class="line">	 * @param request</span><br><span class="line">	 * @param token</span><br><span class="line">	 * @return</span><br><span class="line">	 * @author Damon</span><br><span class="line">	 * @date 2019年8月15日</span><br><span class="line">	 *</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	Response&lt;Object&gt; verify(HttpServletRequest request, String token);</span><br><span class="line"></span><br><span class="line">	Response&lt;Object&gt; updatePwd(HttpServletRequest req, String username, String oldPwd, String newPwd);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;Response&lt;Object&gt; logout(HttpServletRequest req, HttpServletResponse res);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在Spring Security中，有默认的函数<strong>loadUserByUsername</strong>来实现鉴权逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Auth</span><br><span class="line">     * 登录认证</span><br><span class="line">     * 实际中从数据库获取信息</span><br><span class="line">     * 这里为了做演示，把用户名、密码和所属角色都写在代码里了，正式环境中，这里应该是从数据库或者其他地方根据用户名将加密后的密码及所属角色查出来的。账号 damon ，</span><br><span class="line">     * 密码123456，稍后在换取 token 的时候会用到。并且给这个用户设置 &quot;ROLE_ADMIN&quot; 角色。</span><br><span class="line">     *</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">    	logger.info(&quot;clientIp is: &#123;&#125; ,username: &#123;&#125;&quot;, IpUtil.getClientIp(req), username);</span><br><span class="line">		logger.info(&quot;serverIp is: &#123;&#125;&quot;, IpUtil.getCurrentIp());</span><br><span class="line">		&#x2F;&#x2F; 查询数据库操作</span><br><span class="line">		SysUser user &#x3D; userMapper.getUserByUsername(username);</span><br><span class="line">		if (user &#x3D;&#x3D; null) &#123;</span><br><span class="line">			logger.error(&quot;user not exist&quot;);</span><br><span class="line">			throw new UsernameNotFoundException(&quot;username is not exist&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			&#x2F;&#x2F; 用户角色也应在数据库中获取，这里简化</span><br><span class="line">			String role &#x3D; &quot;&quot;;</span><br><span class="line">			if(user.getIsAdmin() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">				role &#x3D; &quot;admin&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">			List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; Lists.newArrayList();</span><br><span class="line">			authorities.add(new SimpleGrantedAuthority(role));</span><br><span class="line">			&#x2F;&#x2F;String password &#x3D; passwordEncoder.encode(&quot;123456&quot;);&#x2F;&#x2F; 123456是密码</span><br><span class="line">			&#x2F;&#x2F;return new User(username, password, authorities);</span><br><span class="line">			&#x2F;&#x2F; 线上环境应该通过用户名查询数据库获取加密后的密码</span><br><span class="line">			return new User(username, user.getPassword(), authorities);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;可以看到通过用户信息获取用户的权限，然后记录用户信息。这里使用redis来记录用户信息以及token信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line">import org.springframework.security.oauth2.provider.token.store.redis.RedisTokenStore;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 使用redis存储token的配置</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月13日 下午3:03:19</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Configuration</span><br><span class="line">public class RedisTokenStoreConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisConnectionFactory redisConnectionFactory;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public TokenStore redisTokenStore ()&#123;</span><br><span class="line">        &#x2F;&#x2F;return new RedisTokenStore(redisConnectionFactory);</span><br><span class="line">    	return new MyRedisTokenStore(redisConnectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;同时，我们自定义了异常处理类，统一处理异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.security.access.AccessDeniedException;</span><br><span class="line">import org.springframework.security.core.AuthenticationException;</span><br><span class="line">import org.springframework.security.oauth2.common.DefaultThrowableAnalyzer;</span><br><span class="line">import org.springframework.security.oauth2.common.exceptions.InsufficientScopeException;</span><br><span class="line">import org.springframework.security.oauth2.common.exceptions.OAuth2Exception;</span><br><span class="line">import org.springframework.security.oauth2.provider.error.WebResponseExceptionTranslator;</span><br><span class="line">import org.springframework.security.web.util.ThrowableAnalyzer;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.HttpRequestMethodNotSupportedException;</span><br><span class="line"></span><br><span class="line">import com.damon.exception.UserOAuth2Exception;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 自定义异常转换类</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年2月27日 上午10:28:19</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">@Component(&quot;userOAuth2WebResponseExceptionTranslator&quot;)</span><br><span class="line">public class UserOAuth2WebResponseExceptionTranslator implements WebResponseExceptionTranslator &#123;</span><br><span class="line">    private ThrowableAnalyzer throwableAnalyzer &#x3D; new DefaultThrowableAnalyzer();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ResponseEntity&lt;OAuth2Exception&gt; translate(Exception e) throws Exception &#123;</span><br><span class="line">        Throwable[] causeChain &#x3D; this.throwableAnalyzer.determineCauseChain(e);</span><br><span class="line">        Exception ase &#x3D; (OAuth2Exception)this.throwableAnalyzer.getFirstThrowableOfType(OAuth2Exception.class, causeChain);</span><br><span class="line">        &#x2F;&#x2F;异常链中有OAuth2Exception异常</span><br><span class="line">        if (ase !&#x3D; null) &#123;</span><br><span class="line">            return this.handleOAuth2Exception((OAuth2Exception)ase);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;身份验证相关异常</span><br><span class="line">        ase &#x3D; (AuthenticationException)this.throwableAnalyzer.getFirstThrowableOfType(AuthenticationException.class, causeChain);</span><br><span class="line">        if (ase !&#x3D; null) &#123;</span><br><span class="line">            return this.handleOAuth2Exception(new UserOAuth2WebResponseExceptionTranslator.UnauthorizedException(e.getMessage(), e));</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;异常链中包含拒绝访问异常</span><br><span class="line">        ase &#x3D; (AccessDeniedException)this.throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException.class, causeChain);</span><br><span class="line">        if (ase instanceof AccessDeniedException) &#123;</span><br><span class="line">            return this.handleOAuth2Exception(new UserOAuth2WebResponseExceptionTranslator.ForbiddenException(ase.getMessage(), ase));</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;异常链中包含Http方法请求异常</span><br><span class="line">        ase &#x3D; (HttpRequestMethodNotSupportedException)this.throwableAnalyzer.getFirstThrowableOfType(HttpRequestMethodNotSupportedException.class, causeChain);</span><br><span class="line">        if(ase instanceof HttpRequestMethodNotSupportedException)&#123;</span><br><span class="line">            return this.handleOAuth2Exception(new UserOAuth2WebResponseExceptionTranslator.MethodNotAllowed(ase.getMessage(), ase));</span><br><span class="line">        &#125;</span><br><span class="line">        return this.handleOAuth2Exception(new UserOAuth2WebResponseExceptionTranslator.ServerErrorException(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase(), e));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ResponseEntity&lt;OAuth2Exception&gt; handleOAuth2Exception(OAuth2Exception e) throws IOException &#123;</span><br><span class="line">        int status &#x3D; e.getHttpErrorCode();</span><br><span class="line">        HttpHeaders headers &#x3D; new HttpHeaders();</span><br><span class="line">        headers.set(&quot;Cache-Control&quot;, &quot;no-store&quot;);</span><br><span class="line">        headers.set(&quot;Pragma&quot;, &quot;no-cache&quot;);</span><br><span class="line">        if (status &#x3D;&#x3D; HttpStatus.UNAUTHORIZED.value() || e instanceof InsufficientScopeException) &#123;</span><br><span class="line">            headers.set(&quot;WWW-Authenticate&quot;, String.format(&quot;%s %s&quot;, &quot;Bearer&quot;, e.getSummary()));</span><br><span class="line">        &#125;</span><br><span class="line">        UserOAuth2Exception exception &#x3D; new UserOAuth2Exception(e.getMessage(),e);</span><br><span class="line">        ResponseEntity&lt;OAuth2Exception&gt; response &#x3D; new ResponseEntity(exception, headers, HttpStatus.valueOf(status));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static class MethodNotAllowed extends OAuth2Exception &#123;</span><br><span class="line">        public MethodNotAllowed(String msg, Throwable t) &#123;</span><br><span class="line">            super(msg, t);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public String getOAuth2ErrorCode() &#123;</span><br><span class="line">            return &quot;method_not_allowed&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public int getHttpErrorCode() &#123;</span><br><span class="line">            return 405;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class UnauthorizedException extends OAuth2Exception &#123;</span><br><span class="line">        public UnauthorizedException(String msg, Throwable t) &#123;</span><br><span class="line">            super(msg, t);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public String getOAuth2ErrorCode() &#123;</span><br><span class="line">            return &quot;unauthorized&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public int getHttpErrorCode() &#123;</span><br><span class="line">            return 401;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class ServerErrorException extends OAuth2Exception &#123;</span><br><span class="line">        public ServerErrorException(String msg, Throwable t) &#123;</span><br><span class="line">            super(msg, t);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public String getOAuth2ErrorCode() &#123;</span><br><span class="line">            return &quot;server_error&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public int getHttpErrorCode() &#123;</span><br><span class="line">            return 500;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class ForbiddenException extends OAuth2Exception &#123;</span><br><span class="line">        public ForbiddenException(String msg, Throwable t) &#123;</span><br><span class="line">            super(msg, t);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public String getOAuth2ErrorCode() &#123;</span><br><span class="line">            return &quot;access_denied&quot;;</span><br><span class="line">	        &#125;</span><br><span class="line">	        @Override</span><br><span class="line">	        public int getHttpErrorCode() &#123;</span><br><span class="line">	            return 403;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;前面是对认证服务进行配置的详解，接下来，我们看看对于资源服务的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 资源服务器配置</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月13日 下午3:03:48</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableResourceServer</span><br><span class="line">public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">    public void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line"></span><br><span class="line">                .exceptionHandling()</span><br><span class="line">        		.authenticationEntryPoint(new AuthenticationEntryPointHandle())</span><br><span class="line">        		&#x2F;&#x2F;.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">        		.and()</span><br><span class="line"></span><br><span class="line">                .requestMatchers().antMatchers(&quot;&#x2F;api&#x2F;**&quot;)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;&#x2F;api&#x2F;**&quot;).authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里也配置了对于资源拦截的统一处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.security.core.AuthenticationException;</span><br><span class="line">import org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.damon.commons.Response;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 统一结果处理</span><br><span class="line"> *</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月16日 上午11:11:44</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class AuthenticationEntryPointHandle implements AuthenticationEntryPoint &#123;</span><br><span class="line">	&#x2F;**</span><br><span class="line">	 *</span><br><span class="line">	 * @author Damon</span><br><span class="line">	 * @date 2020年1月16日</span><br><span class="line">	 *</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Override</span><br><span class="line">	public void commence(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">			AuthenticationException authException) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F;response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">		&#x2F;&#x2F;response.setStatus(HttpStatus.OK.value());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);  &#x2F;&#x2F;gateway已加，无需再加</span><br><span class="line">        &#x2F;&#x2F;response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;token&quot;);</span><br><span class="line">        &#x2F;&#x2F;解决低危漏洞点击劫持 X-Frame-Options Header未配置</span><br><span class="line">        response.setHeader(&quot;X-Frame-Options&quot;, &quot;SAMEORIGIN&quot;);</span><br><span class="line">        response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        response.setContentType(&quot;application&#x2F;json; charset&#x3D;utf-8&quot;);</span><br><span class="line"></span><br><span class="line">		response.getWriter()</span><br><span class="line">		.write(JSON.toJSONString(Response.ok(response.getStatus(), -2, authException.getMessage(), null)));</span><br><span class="line">		&#x2F;*response.getWriter()</span><br><span class="line">				.write(JSON.toJSONString(Response.ok(200, -2, &quot;Internal Server Error&quot;, authException.getMessage())));*&#x2F;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;以上就是认证中心的核心代码了，这里有一些需要注意的地方：有2个拦截器，鉴权服务配置、资源权限配置，鉴权时可以通过几种模式来进行。授权码模式交互比较多，密码模式比较常见应用。</p>
<p>&emsp;&emsp;接下来，我们新建一个电商系统的订单服务，作为鉴权的客户端，我们来看看代码。</p>
<h5 id="订单服务客户端"><a href="#订单服务客户端" class="headerlink" title="订单服务客户端"></a>订单服务客户端</h5><p>&emsp;&emsp;订单系统我们考虑到系统的高可用，以及系统的TPS，我们采用负载均衡手段，加上一些中间件来处理，使得服务更加具有代表性。</p>
<p>&emsp;&emsp;订单系统的环境这就不介绍了，这里主要还是看依赖K8s的组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-actuator-autoconfigure&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-starter-kubernetes-config&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- springcloud-k8s-discovery --&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-commons&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-kubernetes-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-kubernetes-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-starter-kubernetes-ribbon&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上面的依赖是K8s对于Java的sdk-client，接下来配置一些环境使其生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service</span><br><span class="line">  #redis: #redis相关配置</span><br><span class="line">    #password: 123456 #有密码时设置</span><br><span class="line">  cloud:</span><br><span class="line">    kubernetes:</span><br><span class="line">      config:</span><br><span class="line">        sources:</span><br><span class="line">         - name: $&#123;spring.application.name&#125;</span><br><span class="line">           namespace: system-server</span><br><span class="line">      discovery:</span><br><span class="line">        all-namespaces: true</span><br><span class="line">      reload:</span><br><span class="line">        #自动更新配置的开关设置为打开</span><br><span class="line">        enabled: true</span><br><span class="line">        #更新配置信息的模式：polling是主动拉取，event是事件通知</span><br><span class="line">        mode: polling</span><br><span class="line">        #主动拉取的间隔时间是500毫秒</span><br><span class="line">        period: 500</span><br><span class="line">  http:</span><br><span class="line">    encoding:</span><br><span class="line">      charset: UTF-8</span><br><span class="line">      enabled: true</span><br><span class="line">      force: true</span><br><span class="line">  mvc:</span><br><span class="line">    throw-exception-if-no-handler-found: true</span><br><span class="line">  main:</span><br><span class="line">    allow-bean-definition-overriding: true # 当遇到同样名称时，是否允许覆盖注册</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  path: &#x2F;data&#x2F;$&#123;spring.application.name&#125;&#x2F;logs</span><br><span class="line"></span><br><span class="line">cas-server-url: http:&#x2F;&#x2F;cas-server-service #http:&#x2F;&#x2F;localhost:2000#设置可以访问的地址</span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  oauth2: #与cas-server对应的配置</span><br><span class="line">    client:</span><br><span class="line">      client-id: order-service</span><br><span class="line">      client-secret: order-service-123</span><br><span class="line">      user-authorization-uri: $&#123;cas-server-url&#125;&#x2F;oauth&#x2F;authorize #是授权码认证方式需要的</span><br><span class="line">      access-token-uri: $&#123;cas-server-url&#125;&#x2F;oauth&#x2F;token #是密码模式需要用到的获取 token 的接口</span><br><span class="line">    resource:</span><br><span class="line">      loadBalanced: true</span><br><span class="line">      #jwt: #jwt存储token时开启</span><br><span class="line">        #key-uri: $&#123;cas-server-url&#125;&#x2F;oauth&#x2F;token_key</span><br><span class="line">        #key-value: test_jwt_sign_key</span><br><span class="line">      id: order-service</span><br><span class="line">      #指定用户信息地址</span><br><span class="line">      user-info-uri: $&#123;cas-server-url&#125;&#x2F;api&#x2F;user #指定user info的URI，原生地址后缀为&#x2F;auth&#x2F;user</span><br><span class="line">      prefer-token-info: false</span><br><span class="line">      #token-info-uri:</span><br><span class="line">    authorization:</span><br><span class="line">      check-token-access: $&#123;cas-server-url&#125;&#x2F;oauth&#x2F;check_token #当此web服务端接收到来自UI客户端的请求后，需要拿着请求中的 token 到认证服务端做 token 验证，就是请求的这个接口</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最上面是配置了加载服务的环境变量，采用K8s的ConfigMap实现，不再使用复杂的各种大厂提供的插件。下面是订单服务接入鉴权时需要的鉴权配置。这里为了鉴权的健壮性，采用了分布式部署：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cas-server-url: http:&#x2F;&#x2F;cas-server-service</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过K8s的Service来进行及安全认证，实现服务的高可用。接下来是订单服务的各种模式的支持，这里主要是授权码模式、密码模式。同时，开启了订单服务的负载均衡策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.damon;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.SpringBootConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.security.oauth2.client.EnableOAuth2Sso;</span><br><span class="line">import org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line">import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;</span><br><span class="line">import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line">import org.springframework.cloud.netflix.hystrix.EnableHystrix;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">import com.damon.config.EnvConfig;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月13日 下午3:23:06</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">@EnableOAuth2Sso</span><br><span class="line">@Configuration&#x2F;&#x2F;@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(basePackages &#x3D; &#123;&quot;com.damon&quot;&#125;)</span><br><span class="line">@EnableConfigurationProperties(EnvConfig.class)</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableCircuitBreaker&#x2F;&#x2F;@EnableHystrix</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;@RibbonClients针对多个服务源进行策略的指定 ,这里注意这种方式时，RibbonConfiguration类不能被包含在@ComponentScan的扫描包中</span><br><span class="line">&#x2F;*@RibbonClients(value &#x3D; &#123;</span><br><span class="line">		@RibbonClient(name&#x3D;&quot;cas-server-service&quot;, configuration &#x3D; RibbonConfiguration.class),</span><br><span class="line">		@RibbonClient(name&#x3D;&quot;admin-web-service&quot;, configuration &#x3D; RibbonConfiguration.class)</span><br><span class="line">&#125;)*&#x2F;</span><br><span class="line">public class OrderApp &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(OrderApp.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;接下来，我们看下客户端的资源配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line">import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月16日 下午6:28:35</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableResourceServer</span><br><span class="line">public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line"></span><br><span class="line">                .exceptionHandling()</span><br><span class="line">        		.authenticationEntryPoint(new AuthenticationEntryPointHandle())</span><br><span class="line">        		&#x2F;&#x2F;.authenticationEntryPoint((request, response, authException) -&gt; response.sendError(HttpServletResponse.SC_UNAUTHORIZED))</span><br><span class="line">        		.and()</span><br><span class="line"></span><br><span class="line">                .requestMatchers().antMatchers(&quot;&#x2F;api&#x2F;**&quot;)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;&#x2F;api&#x2F;**&quot;).authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里加了一个统一结果处理类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line">import org.springframework.security.core.AuthenticationException;</span><br><span class="line">import org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.damon.commons.Response;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 统一结果处理</span><br><span class="line"> *</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2020年1月16日 上午11:11:44</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class AuthenticationEntryPointHandle implements AuthenticationEntryPoint &#123;</span><br><span class="line">	&#x2F;**</span><br><span class="line">	 *</span><br><span class="line">	 * @author Damon</span><br><span class="line">	 * @date 2020年1月16日</span><br><span class="line">	 *</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Override</span><br><span class="line">	public void commence(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">			AuthenticationException authException) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F;response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">		&#x2F;&#x2F;response.setStatus(HttpStatus.OK.value());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);  &#x2F;&#x2F;gateway已加，无需再加</span><br><span class="line">        &#x2F;&#x2F;response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;token&quot;);</span><br><span class="line">        &#x2F;&#x2F;解决低危漏洞点击劫持 X-Frame-Options Header未配置</span><br><span class="line">        response.setHeader(&quot;X-Frame-Options&quot;, &quot;SAMEORIGIN&quot;);</span><br><span class="line">        response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        response.setContentType(&quot;application&#x2F;json; charset&#x3D;utf-8&quot;);</span><br><span class="line"></span><br><span class="line">		response.getWriter()</span><br><span class="line">		.write(JSON.toJSONString(Response.ok(response.getStatus(), -2, authException.getMessage(), null)));</span><br><span class="line">		&#x2F;*response.getWriter()</span><br><span class="line">				.write(JSON.toJSONString(Response.ok(200, -2, &quot;Internal Server Error&quot;, authException.getMessage())));*&#x2F;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;*@Override</span><br><span class="line">    public void commence(HttpServletRequest request,</span><br><span class="line">                         HttpServletResponse response,</span><br><span class="line">			AuthenticationException authException) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">		response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">		response.setContentType(&quot;application&#x2F;json; charset&#x3D;utf-8&quot;);</span><br><span class="line">		response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">		response.getWriter()</span><br><span class="line">				.write(JSON.toJSONString(Response.ok(200, -2, &quot;Internal Server Error&quot;, authException.getMessage())));</span><br><span class="line">	&#125;*&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;前面说增加了负载均衡策略，此处我们引入的是Ribbon作为负载均衡器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 2003</span><br><span class="line">  undertow:</span><br><span class="line">    accesslog:</span><br><span class="line">      enabled: false</span><br><span class="line">      pattern: combined</span><br><span class="line">  servlet:</span><br><span class="line">    session:</span><br><span class="line">      timeout: PT120M</span><br><span class="line">      cookie:</span><br><span class="line">        name: ORDER-SERVICE-SESSIONID #防止Cookie冲突，冲突会导致登录验证不通过</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client:</span><br><span class="line">  http:</span><br><span class="line">    request:</span><br><span class="line">      connectTimeout: 8000</span><br><span class="line">      readTimeout: 30000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">backend:</span><br><span class="line">  ribbon:</span><br><span class="line">    eureka:</span><br><span class="line">      enabled: false</span><br><span class="line">    client:</span><br><span class="line">      enabled: true</span><br><span class="line">    ServerListRefreshInterval: 5000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ribbon:</span><br><span class="line">  ConnectTimeout: 2000</span><br><span class="line">  ReadTimeout: 3000</span><br><span class="line">  eager-load:</span><br><span class="line">    enabled: true</span><br><span class="line">    clients: cas-server-service,admin-web-service</span><br><span class="line">  MaxAutoRetries: 1 #对第一次请求的服务的重试次数</span><br><span class="line">  MaxAutoRetriesNextServer: 1 #要重试的下一个服务的最大数量（不包括第一个服务）</span><br><span class="line">  #listOfServers: localhost:5556,localhost:5557</span><br><span class="line">  #ServerListRefreshInterval: 2000</span><br><span class="line">  OkToRetryOnAllOperations: true</span><br><span class="line">  NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule #com.damon.config.RibbonConfiguration #自定义策略类</span><br><span class="line"></span><br><span class="line">hystrix:</span><br><span class="line">  command:</span><br><span class="line">    BackendCall: #default or commandKey的值</span><br><span class="line">      execution:</span><br><span class="line">        isolation:</span><br><span class="line">          thread:</span><br><span class="line">            timeoutInMilliseconds: 5000</span><br><span class="line">  threadpool:</span><br><span class="line">    BackendCallThread:</span><br><span class="line">      coreSize: 5</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;同时，这里采用的是默认的轮训策略，当然可以自定义一种策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line">import com.netflix.client.config.IClientConfig;</span><br><span class="line">import com.netflix.loadbalancer.IPing;</span><br><span class="line">import com.netflix.loadbalancer.IRule;</span><br><span class="line">import com.netflix.loadbalancer.PingUrl;</span><br><span class="line">import com.netflix.loadbalancer.RoundRobinRule;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2019年10月30日 下午5:03:54</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class RibbonConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 检查服务是否可用的实例，</span><br><span class="line">     * 此地址返回的响应的返回码如果是200表示服务可用</span><br><span class="line">     * @param config</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public IPing ribbonPing(IClientConfig config)&#123;</span><br><span class="line">        return new PingUrl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 轮询规则</span><br><span class="line">     * @param config</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public IRule ribbonRule(IClientConfig config)&#123;</span><br><span class="line">		&#x2F;&#x2F;return new AvailabilityFilteringRule();</span><br><span class="line">        return new RoundRobinRule();&#x2F;&#x2F;轮询</span><br><span class="line">        &#x2F;&#x2F;return new RetryRule();&#x2F;&#x2F;重试</span><br><span class="line">		&#x2F;&#x2F;return new RandomRule();&#x2F;&#x2F;这里配置策略，和配置文件对应</span><br><span class="line">		&#x2F;&#x2F;return new WeightedResponseTimeRule();&#x2F;&#x2F;这里配置策略，和配置文件对应</span><br><span class="line">        &#x2F;&#x2F;return new BestAvailableRule();&#x2F;&#x2F;选择一个最小的并发请求的server</span><br><span class="line">        &#x2F;&#x2F;return new MyProbabilityRandomRule();&#x2F;&#x2F;自定义</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在上面的策略函数<strong>ribbonRule</strong>中，实现自定义策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package com.damon.config;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Random;</span><br><span class="line"></span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import com.netflix.loadbalancer.BaseLoadBalancer;</span><br><span class="line">import com.netflix.loadbalancer.ILoadBalancer;</span><br><span class="line">import com.netflix.loadbalancer.IRule;</span><br><span class="line">import com.netflix.loadbalancer.Server;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 实现自定义负载均衡策略</span><br><span class="line"> * @author Damon</span><br><span class="line"> * @date 2019年10月30日 上午9:08:49</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class MyProbabilityRandomRule implements IRule &#123;</span><br><span class="line"></span><br><span class="line">	Logger log &#x3D; LoggerFactory.getLogger(MyProbabilityRandomRule.class);</span><br><span class="line"></span><br><span class="line">	ILoadBalancer balancer &#x3D; new BaseLoadBalancer();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Server choose(Object key) &#123;</span><br><span class="line">		List&lt;Server&gt; allServers &#x3D; balancer.getAllServers();</span><br><span class="line">		Random random &#x3D; new Random();</span><br><span class="line">		final int number &#x3D; random.nextInt(10);</span><br><span class="line">		if (number &lt; 7) &#123;</span><br><span class="line">			return findServer(allServers,8091);</span><br><span class="line">		&#125;</span><br><span class="line">		return findServer(allServers,8092);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private Server findServer(List&lt;Server&gt; allServers, int port) &#123;</span><br><span class="line">		for (Server server : allServers) &#123;</span><br><span class="line">			if (server.getPort() &#x3D;&#x3D; port) &#123;</span><br><span class="line">				return server;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		log.info(&quot;NULL port&#x3D;&quot;+port);</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setLoadBalancer(ILoadBalancer lb) &#123;</span><br><span class="line">		this.balancer &#x3D; lb;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public ILoadBalancer getLoadBalancer() &#123;</span><br><span class="line">		return this.balancer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;到此，关于客户端的配置全部解决完了，接下来简单写一个API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;getCurrentOrderUser&quot;)</span><br><span class="line">@PreAuthorize(&quot;hasAuthority(&#39;admin&#39;)&quot;)</span><br><span class="line">public Object getCurrentOrderUser(Authentication authentication) &#123;</span><br><span class="line">	logger.info(&quot;test password&quot;);</span><br><span class="line">	return authentication;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;@PreAuthorize(&quot;hasAuthority(&#39;admin&#39;)&quot;)</span><br><span class="line">@PreAuthorize(&quot;hasAuthority(&#39;admin1&#39;)&quot;)</span><br><span class="line">@GetMapping(&quot;&#x2F;auth&#x2F;admin&quot;)</span><br><span class="line">public Object adminAuth() &#123;</span><br><span class="line">	logger.info(&quot;aAaqsqwsw&quot;);</span><br><span class="line">	return &quot;Has admin auth!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们简单的实现了一个客户端的代码，以及鉴权认证。</p>
<h5 id="基于Java阐述K8s的服务发现"><a href="#基于Java阐述K8s的服务发现" class="headerlink" title="基于Java阐述K8s的服务发现"></a>基于Java阐述K8s的服务发现</h5><p>&emsp;&emsp;前面从K8s组件以及资源的角度，来分析了K8s的服务注册与发现的缘由。接下来，我们看看基于Java，K8s如何提供该项功能。</p>
<p>&emsp;&emsp;在pom.xml中，有对spring-cloud-kubernetes框架的依赖配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-cloud-kubernetes-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>我们看下这个依赖的源码：</p>
<p><img src="https://static001.geekbang.org/infoq/36/3695035fe29b6bca5a1215a52633e8f8.png" alt=""></p>
<p>&emsp;&emsp;spring容器启动时，会找到classpath下的spring.factories文件，spring.factories文件中有两个类：KubernetesDiscoveryClientAutoConfiguration和KubernetesDiscoveryClientConfigClientBootstrapConfiguration都会被实例化；</p>
<p>&emsp;&emsp;再看KubernetesDiscoveryClientAutoConfiguration源码，注意<strong>kubernetesDiscoveryClient</strong>方法，这里面实例化了DiscoveryController所需的DiscoveryClient接口实现:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">@ConditionalOnProperty(name &#x3D; &quot;spring.cloud.kubernetes.discovery.enabled&quot;, matchIfMissing &#x3D; true)</span><br><span class="line">public KubernetesDiscoveryClient kubernetesDiscoveryClient(KubernetesClient client,</span><br><span class="line">			KubernetesDiscoveryProperties properties,</span><br><span class="line">			KubernetesClientServicesFunction kubernetesClientServicesFunction,</span><br><span class="line">			DefaultIsServicePortSecureResolver isServicePortSecureResolver) &#123;</span><br><span class="line">  return new KubernetesDiscoveryClient(client, properties,</span><br><span class="line">                                       kubernetesClientServicesFunction, isServicePortSecureResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;其实最终是向kubernetes的API Server发起http请求，获取service资源的数据列表；在K8s的API Server收到请求后，<strong>由API Server从etcd中取得service的数据返回</strong>。</p>
<p><img src="https://static001.geekbang.org/infoq/25/2574415575c013a810fa2bbb0ac04720.png" alt=""></p>
<p>&emsp;&emsp;可见 spring-cloud-kubernetes 的 DiscoveryClient 服务将 kubernetes 中的”service”资源与 SpringCloud 中的服务对应起来了，有了这个 DiscoveryClient，我们在 kubernetes 环境就不需要 eureka 来做注册发现了，而是直接使用 kubernetes 的服务机制，此时不得不感慨 SpringCloud 的对 DiscoveryClient 的设计是如此的精妙。</p>
<h6 id="7-2-手写第一个Golang微服务"><a href="#7-2-手写第一个Golang微服务" class="headerlink" title="7.2 手写第一个Golang微服务"></a>7.2 手写第一个Golang微服务</h6><p>&emsp;&emsp;现在有不少的Golang框架：Beego、Gin等，今天为了简单起见，我们直接使用Beego。</p>
<h6 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h6><ul>
<li>GoLand 2020.3.2</li>
<li>Golang 1.12+</li>
</ul>
<p>第一个Golang的main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&quot;</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&#x2F;logs&quot;</span><br><span class="line">	&quot;github.com&#x2F;spf13&#x2F;pflag&quot;</span><br><span class="line">	_ &quot;pay-service&#x2F;routers&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	logs.SetLogFuncCall(true)</span><br><span class="line">	logs.SetLogFuncCallDepth(3)</span><br><span class="line">	logs.SetLogger(logs.AdapterFile, &#96;&#123;&quot;filename&quot;:&quot;&#x2F;data&#x2F;pay-service&#x2F;log&#x2F;pay-service.log&quot;,&quot;level&quot;:7,&quot;daily&quot;:true,&quot;maxdays&quot;:7,&quot;color&quot;:true&#125;&#96;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var logFlushFreq &#x3D; pflag.Duration(&quot;log-flush-frequency&quot;, 5*time.Second, &quot;Maximum number of seconds between log flushes&quot;)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	&#x2F;&#x2F;先在先执行，后者不再执行</span><br><span class="line"></span><br><span class="line">	&#x2F;*http.HandleFunc(&quot;&#x2F;health&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">		fmt.Fprintf(w, fmt.Sprintf(&quot;%v&quot;, true))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(&quot;:38080&quot;, nil)*&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	beego.Run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;cache health</span><br><span class="line">	&#x2F;&#x2F;var configFile &#x3D; flag.String(&quot;config&quot;, &quot;conf&#x2F;config-dev.yaml&quot;, &quot;the config file of pay service&quot;)</span><br><span class="line">	&#x2F;*flag.Parse()</span><br><span class="line"></span><br><span class="line">	go wait.Until(glog.Flush, *logFlushFreq, wait.NeverStop)</span><br><span class="line">	defer glog.Flush()</span><br><span class="line"></span><br><span class="line">	config, err :&#x3D; config.ParseFromYaml(*configFile)</span><br><span class="line">	if config.ProcessNum &gt; 0 &#123;</span><br><span class="line">		runtime.GOMAXPROCS(config.ProcessNum)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		runtime.GOMAXPROCS(runtime.NumCPU())</span><br><span class="line">	&#125;</span><br><span class="line">	runtime.NumCPU()</span><br><span class="line"></span><br><span class="line">	cache :&#x3D; cache.New(&amp;cache.Config&#123;&#125;)</span><br><span class="line">	done :&#x3D; make(chan struct&#123;&#125;)</span><br><span class="line">	cache.Run(done)</span><br><span class="line">	&lt;-done*&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里启动时，很简单，就是beego的线程启动，当然，如果你需要添加一些其他的，可以在<strong>init</strong>函数中添加逻辑。</p>
<p>&emsp;&emsp;接下来，我们新建一个routers目录，新建router文件来设置路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; @APIVersion V1.0.0</span><br><span class="line">&#x2F;&#x2F; @Title 支付服务 API</span><br><span class="line">&#x2F;&#x2F; @Description 提供支付服务相关的API集合.</span><br><span class="line">package routers</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&quot;</span><br><span class="line">	&quot;pay-service&#x2F;api&quot;</span><br><span class="line">	&quot;common-core&#x2F;common&#x2F;check&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	ns :&#x3D; beego.NewNamespace(&quot;&#x2F;api&#x2F;v1&quot;,</span><br><span class="line">		beego.NSRouter(&quot;&#x2F;healthz&quot;, &amp;api.ProbeHealthAPI&#123;&#125;),</span><br><span class="line">		beego.NSRouter(&quot;&#x2F;pay&#x2F;:orderId&quot;, &amp;api.PayDetailAPI&#123;&#125;),</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	beego.InsertFilter(&quot;&#x2F;api&#x2F;v1&#x2F;*&quot;, beego.BeforeRouter, check.CheckAuth)</span><br><span class="line">	beego.AddNamespace(ns)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上面的路由包括两个接口，一个是服务自身的健康检测healthz，还有一个基于订单号查询支付服务信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package api</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	base_api &quot;common-core&#x2F;common&#x2F;api&quot;</span><br><span class="line">	&quot;strings&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type PayDetailAPI struct &#123;</span><br><span class="line">	base_api.BaseAPI</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (pd *PayDetailAPI) Get() &#123;</span><br><span class="line">	orderId :&#x3D; strings.TrimSpace(pd.GetString(&quot;:orderId&quot;))</span><br><span class="line">	pd.RespSucc(&quot;success: &quot; + orderId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里由于API需要集成Beego的控制类，所以新建一个common目录，提供基础功能，包括api：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package api</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;common-core&#x2F;common&#x2F;handler&quot;</span><br><span class="line">	&quot;common-core&#x2F;common&#x2F;res&quot;</span><br><span class="line">	&quot;encoding&#x2F;json&quot;</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&quot;</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&#x2F;logs&quot;</span><br><span class="line">	&quot;io&#x2F;ioutil&quot;</span><br><span class="line">	&quot;net&#x2F;http&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type BaseAPI struct &#123;</span><br><span class="line">	beego.Controller</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func (ba *BaseAPI) GetBody(body interface&#123;&#125;) error &#123;</span><br><span class="line">	bodyByte, err :&#x3D; ioutil.ReadAll(ba.Ctx.Request.Body)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		logs.Error(err.Error())</span><br><span class="line">		return handler.NewBadReqError(handler.ComErrorCodeInvalidPara, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if err :&#x3D; json.Unmarshal(bodyByte, body); err !&#x3D; nil &#123;</span><br><span class="line">		return handler.NewBadReqError(handler.ComErrorCodeInvalidPara, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (ba *BaseAPI) RespSucc(body interface&#123;&#125;) &#123;</span><br><span class="line">	ba.Resp(http.StatusOK, (&amp;res.DefaultResponse&#123;&#125;).Succ(body))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (ba *BaseAPI) RespError(err error) &#123;</span><br><span class="line">	if handler.IsBadRequestError(err) &#123;</span><br><span class="line">		ba.Resp(http.StatusBadRequest, (&amp;res.DefaultResponse&#123;&#125;).Fail(err))</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		ba.Resp(http.StatusInternalServerError, (&amp;res.DefaultResponse&#123;&#125;).Fail(err))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (ba *BaseAPI) RespSuccError(err error) &#123;</span><br><span class="line">	if handler.IsBadRequestError(err) &#123;</span><br><span class="line">		ba.Resp(http.StatusOK, (&amp;res.DefaultResponse&#123;&#125;).Fail(err))</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		ba.Resp(http.StatusOK, (&amp;res.DefaultResponse&#123;&#125;).Fail(err))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (ba *BaseAPI) Resp(httpStatus int, res res.Response) &#123;</span><br><span class="line">	ba.Data[&quot;json&quot;] &#x3D; res</span><br><span class="line">	ba.Ctx.Output.SetStatus(httpStatus)</span><br><span class="line">	ba.ServeJSON()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;同时，提供了一些异常处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">package handler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	&#x2F;&#x2F;公共错误码 0-100</span><br><span class="line">	ComErrorCodeSuccess     &#x3D; 0</span><br><span class="line">	ComErrorCodeNoVistAuth  &#x3D; 1</span><br><span class="line">	ComErrorCodeInvalidPara &#x3D; 2</span><br><span class="line">	ComErrorCodeUnknown &#x3D; 3</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	badRequestType &#x3D; &quot;[bad request]&quot;</span><br><span class="line">	innerErrorType &#x3D; &quot;[inner error]&quot;</span><br><span class="line">	successType    &#x3D; &quot;[success]&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type ExceptionHandler struct &#123;</span><br><span class="line">	Code      int    &#96;json:&quot;code&quot;&#96;</span><br><span class="line">	ErrorType string &#96;json:&quot;-&quot;&#96;</span><br><span class="line">	Msg       string &#96;json:&quot;msg&quot;&#96;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (ec ExceptionHandler) Error() string &#123;</span><br><span class="line">	return ec.Msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewBadReqError(code int, format string, paras ...interface&#123;&#125;) error &#123;</span><br><span class="line">	return newError(code, badRequestType, format, paras...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewInnerError(code int, format string, paras ...interface&#123;&#125;) error &#123;</span><br><span class="line">	return newError(code, innerErrorType, format, paras...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewSuccess(format string, paras ...interface&#123;&#125;) error &#123;</span><br><span class="line">	return newError(ComErrorCodeSuccess, successType, format, paras...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewUnkownError(format string, paras ...interface&#123;&#125;) error &#123;</span><br><span class="line">	return newError(ComErrorCodeUnknown, innerErrorType, format, paras...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsInnerError(err error) bool &#123;</span><br><span class="line">	if errCustom, ok :&#x3D; err.(ExceptionHandler); ok &#123;</span><br><span class="line">		return errCustom.ErrorType &#x3D;&#x3D; innerErrorType</span><br><span class="line">	&#125;</span><br><span class="line">	return false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsBadRequestError(err error) bool &#123;</span><br><span class="line">	if errCustom, ok :&#x3D; err.(ExceptionHandler); ok &#123;</span><br><span class="line">		return errCustom.ErrorType &#x3D;&#x3D; badRequestType</span><br><span class="line">	&#125;</span><br><span class="line">	return false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsSuccess(err error) bool &#123;</span><br><span class="line">	if err &#x3D;&#x3D; nil &#123;</span><br><span class="line">		return true</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if errCustom, ok :&#x3D; err.(*ExceptionHandler); ok &#123;</span><br><span class="line">		return errCustom.ErrorType &#x3D;&#x3D; successType</span><br><span class="line">	&#125;</span><br><span class="line">	return false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewError(code int, format string, paras ...interface&#123;&#125;) *ExceptionHandler &#123;</span><br><span class="line">	return &amp;ExceptionHandler&#123;Code: code, Msg: fmt.Sprintf(format, paras...)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newError(code int, errorType string, format string, paras ...interface&#123;&#125;) error &#123;</span><br><span class="line">	return &amp;ExceptionHandler&#123;Code: code, ErrorType: errorType, Msg: fmt.Sprintf(format, paras...)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;返回响应体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package res</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&#x2F;&#x2F; http client driver</span><br><span class="line">	&quot;github.com&#x2F;astaxie&#x2F;beego&#x2F;logs&quot;</span><br><span class="line">	&quot;common-core&#x2F;common&#x2F;handler&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type Response interface &#123;</span><br><span class="line">	Succ(body interface&#123;&#125;) Response</span><br><span class="line">	Fail(err error) Response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type DefaultResponse struct &#123;</span><br><span class="line">	Status handler.ExceptionHandler &#96;json:&quot;status&quot;&#96;</span><br><span class="line">	Data   interface&#123;&#125;             &#96;json:&quot;data&quot;&#96;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (dr *DefaultResponse) Succ(body interface&#123;&#125;) Response &#123;</span><br><span class="line">	success, _ :&#x3D; handler.NewSuccess(&quot;success&quot;).(*handler.ExceptionHandler)</span><br><span class="line">	dr.Status &#x3D; *success</span><br><span class="line">	dr.Data &#x3D; body</span><br><span class="line">	return dr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (dr *DefaultResponse) Fail(err error) Response &#123;</span><br><span class="line">	errCustom, ok :&#x3D; err.(*handler.ExceptionHandler)</span><br><span class="line">	if !ok &#123;</span><br><span class="line">		logs.Error(&quot;error type invalid, please use custom error&quot;)</span><br><span class="line">		unkownError, _ :&#x3D; handler.NewUnkownError(err.Error()).(*handler.ExceptionHandler)</span><br><span class="line">		dr.Status &#x3D; *unkownError</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		dr.Status &#x3D; *errCustom</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return dr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;到此，一个简单的微服务就写完了，如果需要借助一些缓存，或插件来实现一些功能，可以自行添加。</p>
<p>启动微服务，可以运行<strong>main</strong>函数，输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021&#x2F;04&#x2F;13 16:51:38.785 [I] [app.go:214]  http server Running on http:&#x2F;&#x2F;:8080</span><br></pre></td></tr></table></figure>

<p>通过在浏览器输入请求地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;v1&#x2F;healthz</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;v1&#x2F;pay&#x2F;232</span><br></pre></td></tr></table></figure>
<p>如果增加鉴权认证，则会返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;status&quot;:&#123;&quot;code&quot;:1,&quot;msg&quot;:&quot;no token&quot;&#125;,&quot;data&quot;:null&#125;</span><br></pre></td></tr></table></figure>

<h6 id="7-3-部署微服务应用-1"><a href="#7-3-部署微服务应用-1" class="headerlink" title="7.3 部署微服务应用"></a>7.3 部署微服务应用</h6><h6 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h6><p>&emsp;&emsp;这里引入了部署框架，具体内容将在后续公开，现在先来看看如何部署cas-server：</p>
<h6 id="安装教程"><a href="#安装教程" class="headerlink" title="安装教程"></a>安装教程</h6><ul>
<li><p>git clone <a href="https://gitee.com/damon_one/microservice-k8s.git" target="_blank" rel="noopener">https://gitee.com/damon_one/microservice-k8s.git</a></p>
</li>
<li><p>kubectl create namespace system-server</p>
</li>
<li><p>在microservice-k8s目录下</p>
</li>
</ul>
<ol>
<li><p>sh install_requirement.sh</p>
</li>
<li><p>cd build</p>
</li>
<li><p>修改对应的配置</p>
</li>
</ol>
<ul>
<li>vi ../deployment/quick-start/quick-start-AIO-example.yaml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">default:</span><br><span class="line">  cluster_id: singlebox</span><br><span class="line">  gpu_version: 440.31</span><br><span class="line">  mysql_password: ssswsw</span><br><span class="line">cluster_server:</span><br><span class="line">  default:</span><br><span class="line">    ssh-username: damon #机器用户名</span><br><span class="line">    ssh-password: wwwww #机器密码</span><br><span class="line">    gpu:</span><br><span class="line">      type: debug</span><br><span class="line">      count: 2</span><br><span class="line">    cpu: 24</span><br><span class="line">    mem: 187</span><br><span class="line">  master:</span><br><span class="line">  - ip: 10.12.3.17</span><br><span class="line">    hostname: damon</span><br><span class="line">    username: damon</span><br><span class="line">    passworld: wwwww</span><br><span class="line">    gpu:</span><br><span class="line">    # required if</span><br><span class="line">      type: debug</span><br><span class="line">      count: 2</span><br><span class="line">#  compute:</span><br><span class="line">#  - ip: &lt;compute node ip&gt;</span><br><span class="line">#    hostname: &lt;compute node hostname&gt;</span><br><span class="line">#    gpu:</span><br><span class="line">#    # the type and count must be configured at same time</span><br><span class="line">#     type: &lt;gpu type that is different from default&gt;</span><br><span class="line">#      count: &lt;gpu type that is different from default&gt;</span><br><span class="line"></span><br><span class="line">registry_info:</span><br><span class="line">  # the registry address of docker,format [ip:port] eg. 10.10.8.100:5000</span><br><span class="line">  domain: 10.10.8.100:5000</span><br><span class="line">  # the registry&#39;s username</span><br><span class="line">  username: admin</span><br><span class="line">  # the registry&#39;s password</span><br><span class="line">  password: wdwwdwwdw</span><br><span class="line">  # the namespace of kubeletes</span><br><span class="line">  k8s_namespace: singlebox_google_containers</span><br><span class="line">  # the namespace of services</span><br><span class="line">  leinao_namespace: hub</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>sudo python ../controller.py config generate -i /home/damon/microservice-k8s/deployment/quick-start/quick-start-AIO-example.yaml -o /home/damon/deployment/output_config</li>
</ol>
<ul>
<li>按照config部署k8s(可不操作，默认已经部署k8s)</li>
</ul>
<ol>
<li><p>sudo python ../controller.py cluster k8s-clean -p /home/damon/deployment/output_config</p>
</li>
<li><p>sudo python ../controller.py cluster k8s-bootup -p /home/damon/deployment/output_config</p>
</li>
</ol>
<ul>
<li>把config配置push到远程,k8s重新部署时需要执行:</li>
</ul>
<ol>
<li>sudo python ../controller.py config push -p /home/damon/deployment/output_config<br>one</li>
</ol>
<ul>
<li>编译镜像：</li>
</ul>
<ol>
<li>sudo python pai_build.py build -c /home/damon/deployment/output_config -s cas-server</li>
<li>sudo python pai_build.py push -c /home/damon/deployment/output_config -i cas-server</li>
</ol>
<ul>
<li>部署服务：one</li>
</ul>
<ol>
<li>sudo python ../controller.py service delete -n cas-server or mysql</li>
<li>sudo python ../controller.py service start -n cas-server</li>
</ol>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p>部署后，我们可以执行K8s命令查看服务pod：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~$ kubectl get po -n system-server</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">cas-server-deployment-6bdw56dwde-5pdwf   1&#x2F;1     Running   0          3d</span><br><span class="line">gateway-service-deployment-6b7856bc99-5pk56   1&#x2F;1     Running   0          5d3h</span><br><span class="line">order-service-76f57dbd7c-rpfls                  1&#x2F;1   Running   0          10d</span><br><span class="line">pay-service-68bcc4db8-v42gm                  1&#x2F;1     Running   0          10d</span><br></pre></td></tr></table></figure>

<p>不同 NS 之间服务的互通：</p>
<p>kube-system —&gt; system-server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl exec -it order-service-76f57dbd7c-rpfls sh -n kube-system</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"># curl http:&#x2F;&#x2F;pay-service-svc.system-server.svc.cluster.local:8090&#x2F;api&#x2F;v1&#x2F;healthz</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &#123;</span><br><span class="line">    &quot;code&quot;: 0,</span><br><span class="line">    &quot;msg&quot;: &quot;success&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;data&quot;: &quot;success&quot;</span><br><span class="line">&#125;#</span><br><span class="line">#</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>system-server —&gt; kube-system</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~&#x2F;damon$ kubectl exec -it pay-service-768bcc4db8-v42gm sh -n system-server</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"># curl http:&#x2F;&#x2F;order-service-svc.kube-system.svc.cluster.local:9300&#x2F;api&#x2F;v1&#x2F;orders</span><br><span class="line">&#123;&quot;status&quot;:&#123;&quot;code&quot;:1,&quot;msg&quot;:&quot;no token&quot;&#125;,&quot;data&quot;:null&#125;#</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>当出现鉴权认证时，需要获取鉴权令牌Token：</p>
<h6 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h6><ol>
<li>获取授权码</li>
</ol>
<p>页面打开url：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:2000&#x2F;oauth&#x2F;authorize?response_type&#x3D;code&amp;client_id&#x3D;order-service&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;order-service&#x2F;login&amp;scope&#x3D;all</span><br></pre></td></tr></table></figure>

<p>此时，页面被拦截到登录页：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/qnzibd6OnPzZnYURl87eVH8l5xUwJmL79XgdR8ChGFibhOuDhalnq0e5Gwj4Nb4V0BvyCWG0WIxy11MudHsAaDxw/640" alt=""></p>
<p>在点击 Approve、Authorize 后，输入用户名、密码，跳转到上面的重定向地址，并带有 code 属性参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;order-service&#x2F;login?code&#x3D;nbkiUe</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>根据 code 获取 access_token</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST -d &quot;grant_type&#x3D;authorization_code&amp;code&#x3D;nbkiUe&amp;client_id&#x3D;order-service&amp;client_secret&#x3D;order-service-123&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;order-service&#x2F;login&quot; http:&#x2F;&#x2F;localhost:2000&#x2F;oauth&#x2F;token</span><br></pre></td></tr></table></figure>

<p>返回信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;access_token&quot;:&quot;a2af3f0b-27da-41b8-90c0-3bd2a1ed0421&quot;,&quot;token_type&quot;:&quot;bearer&quot;,&quot;refresh_token&quot;:&quot;91c22287-aa24-4305-95cf-38f7903865f3&quot;,&quot;expires_in&quot;:3283,&quot;scope&quot;:&quot;all&quot;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>拿到 token 获取用户信息</li>
</ol>
<ul>
<li>头部携带</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;Accept: application&#x2F;json&quot; -H &quot;Authorization:bearer a2af3f0b-27da-41b8-90c0-3bd2a1ed0421&quot; -X GET http:&#x2F;&#x2F;localhost:2003&#x2F;api&#x2F;order&#x2F;getCurrentOrderUser</span><br></pre></td></tr></table></figure>

<ul>
<li>直接 get 方式传 token</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:2003&#x2F;api&#x2F;order&#x2F;getCurrentOrderUser?access_token&#x3D;a2af3f0b-27da-41b8-90c0-3bd2a1ed0421</span><br><span class="line"></span><br><span class="line">curl -i -X POST http:&#x2F;&#x2F;localhost:2003&#x2F;api&#x2F;order&#x2F;***?access_token&#x3D;a2af3f0b-27da-41b8-90c0-3bd2a1ed0421</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>刷新token</li>
</ol>
<p>通过上面的 “refresh_token” 来刷新获取新 token:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST -d &quot;grant_type&#x3D;refresh_token&amp;refresh_token&#x3D;91c22287-aa24-4305-95cf-38f7903865f3&amp;client_id&#x3D;provider-service&amp;client_secret&#x3D;provider-service-123&quot; http:&#x2F;&#x2F;localhost:2000&#x2F;oauth&#x2F;token</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>退出</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;Accept: application&#x2F;json&quot; -H &quot;Authorization:bearer 01f1beaa-ae21-4920-a349-be786ba327e7&quot; -X DELETE http:&#x2F;&#x2F;localhost:2000&#x2F;api&#x2F;logout</span><br></pre></td></tr></table></figure>

<h6 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h6><p>密码模式由于都是通过直接调用服务来获取token，所以，咱们可以直接在容器内运行，看看效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">curl -i -X POST -d &quot;username&#x3D;admin&amp;password&#x3D;123456&amp;grant_type&#x3D;password&amp;client_id&#x3D;order-service&amp;client_secret&#x3D;order-service-123&amp;scope&#x3D;all&quot; http:&#x2F;&#x2F;cas-server-service.system-server.svc.cluster.local:2000&#x2F;oauth&#x2F;token</span><br><span class="line">Basic模式认证：</span><br><span class="line">curl -i -X POST -H &quot;Authorization:Basic YWRtaW4td2ViOmFkbWluLXdlYi0xMjM&#x3D;&quot; -H &quot;Content-Type:application&#x2F;x-www-form-urlencoded&quot; -d &quot;username&#x3D;admin&amp;password&#x3D;123456&amp;grant_type&#x3D;password&amp;scope&#x3D;all&quot; http:&#x2F;&#x2F;cas-server-service.system-server.svc.cluster.local:2000&#x2F;oauth&#x2F;token</span><br></pre></td></tr></table></figure>

<p>认证成功后，会返回如下结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;access_token&quot;:&quot;d2066f68-665b-4038-9dbe-5dd1035e75a0&quot;,&quot;token_type&quot;:&quot;bearer&quot;,&quot;refresh_token&quot;:&quot;44009836-731c-4e6a-9cc3-274ce3af8c6b&quot;,&quot;expires_in&quot;:3599,&quot;scope&quot;:&quot;all&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们通过 token 来访问接口:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;Accept: application&#x2F;json&quot; -H &quot;Authorization:bearer 9f7a31d6-8d8e-4ff5-a532-a334e630ebcf&quot; -X GET http:&#x2F;&#x2F;order-service-service.system-server.svc.cluster.local:2003&#x2F;api&#x2F;order&#x2F;auth&#x2F;admin</span><br><span class="line">curl -i -H &quot;Accept: application&#x2F;json&quot; -H &quot;Authorization:bearer cb5e8a95-0071-4c1e-b427-5fa58c0c7737&quot; -X GET http:&#x2F;&#x2F;pay-service-svc.system-server.svc.cluster.local:8090&#x2F;api&#x2F;v1&#x2F;pay&#x2F;wwww</span><br><span class="line">curl -i -H &quot;Accept: application&#x2F;json&quot; -H &quot;Authorization:bearer 9f7a31d6-8d8e-4ff5-a532-a334e630ebcf&quot; -X GET http:&#x2F;&#x2F;admin-web-service.system-server.svc.cluster.local:2001&#x2F;api&#x2F;user&#x2F;services</span><br></pre></td></tr></table></figure>

<p>成功会返回结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Has admin auth!</span><br></pre></td></tr></table></figure>

<p>token 如果失效，会返回:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;error&quot;:&quot;invalid_token&quot;,&quot;error_description&quot;:&quot;d2066f68-665b-4038-9dbe-5dd1035e75a01&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要通过Service来进行服务访问，实现基于K8s的负载均衡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tom@PK001:~$ kubectl get svc -n system-server</span><br><span class="line">NAME                             TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">gateway-service-service       ClusterIP   20.16.1.5     &lt;none&gt;        5556&#x2F;TCP       74d</span><br><span class="line">pay-service-svc               ClusterIP   20.16.63.79   &lt;none&gt;        8090&#x2F;TCP       10d</span><br><span class="line">admin-web-service             ClusterIP   10.16.129.24    &lt;none&gt;        2001&#x2F;TCP     84d</span><br><span class="line">cas-server-service            ClusterIP   10.16.230.167   &lt;none&gt;        2000&#x2F;TCP     67d</span><br><span class="line">cloud-admin-service-service   ClusterIP   10.16.25.178    &lt;none&gt;        1001&#x2F;TCP     190d</span><br></pre></td></tr></table></figure>




<h3 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h3><h4 id="云原生技术与微服务架构的天衣无缝"><a href="#云原生技术与微服务架构的天衣无缝" class="headerlink" title="云原生技术与微服务架构的天衣无缝"></a>云原生技术与微服务架构的天衣无缝</h4><p>&emsp;&emsp;云原生的微服务架构是云原生技术和微服务架构的完美结合。微服务作为一种架构风格，所解决的问题是交纵复杂的软件系统的架构与设计；云原生技术乃一种实现方式，所解决的问题是软件系统的运行、维护和治理。微服务架构可以选择不同的实现方式，如 Java 中的 Dubbo、Spring Cloud、Spring Cloud Alibaba，Golang 中的 Beego，Python 中的 Flask 等。但这些不同语言的服务之间的访问与运行可能存在一定得困难性与复杂性。但，云原生和微服务架构的结合，使得它们相得益彰。这其中的原因在于：云原生技术可以有效地弥补微服务架构所带来的实现上的复杂度；微服务架构难以落地的一个重要原因是它过于复杂，对开发团队的组织管理、技术水平和运维能力都提出了极高的要求。因此，一直以来只有少数技术实力雄厚的大企业会采用微服务架构。随着云原生技术的流行，在弥补了微服务架构的这一个短板之后，极大地降低了微服务架构实现的复杂度，使得广大的中小企业有能力在实践中应用微服务架构。云原生技术促进了微服务架构的推广，也是微服务架构落地的最佳搭配。</p>
<h4 id="云原生时代的微服务的未来"><a href="#云原生时代的微服务的未来" class="headerlink" title="云原生时代的微服务的未来"></a>云原生时代的微服务的未来</h4><p>&emsp;&emsp;云原生的第一个发展趋势：标准化和规范化，该技术的基础是容器化和容器编排技术，最经常会用到的技术是 Kubernetes 和 Docker 等。随着云原生技术的发展，云原生技术的标准化和规范化工作正在不断推进，其目的是促进技术的发展和避免供应商锁定的问题，这对于整个云原生技术的生态系统是至关重要的。</p>
<p>&emsp;&emsp;云原生的第二个发展趋势：平台化，以服务网格技术为代表，这一趋势的出发点是增强云平台的能力，从而降低运维的复杂度。流量控制、身份认证和访问控制、性能指标数据收集、分布式服务追踪和集中式日志管理等功能，都可以由底层平台来提供，这就极大地降低了中小企业在运行和维护云原生应用时的复杂度，服务网格以 Istio 和 Linkerd 为开源代表。</p>
<p>&emsp;&emsp;云原生的第三个发展趋势：应用管理技术的进步，如在 Kubernetes 平台上部署和更新应用一直以来都比较复杂，传统的基于资源声明 YAML 文件的做法，已经逐步被 Helm 所替代。操作员模式在 Helm 的基础上更进一步，以更高效、自动化和可扩展的方式对应用部署进行管理。</p>
<h3 id="开源项目"><a href="#开源项目" class="headerlink" title="开源项目"></a>开源项目</h3><p>&emsp;&emsp;实践项目开源：<a href="https://gitee.com/damon_one/microservice-k8s" target="_blank" rel="noopener">云原生微服务架构设计实战代码</a>。</p>
<p><strong>欢迎大家star、fork</strong>，欢迎联系我，一起学习。</p>
<br data-tool="mdnice编辑器">

<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">结束福利</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">开源实战利用 k8s 作微服务的架构设计代码：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #282c34; border-radius: 5px;">https://gitee.com/damon_one/spring-cloud-k8s
https://gitee.com/damon_one/spring-cloud-oauth2
</code></pre>

<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">欢迎大家 star，多多指教。</p>
<br data-tool="mdnice编辑器">

<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">关于作者</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">  <em style="font-style: italic; color: black;">笔名：Damon，技术爱好者，长期从事 Java 开发、Spring Cloud 的微服务架构设计，以及结合 Docker、K8s 做微服务容器化，自动化部署等一站式项目部署、落地。目前主要从事基于 K8s 云原生架构研发的工作。Golang 语言开发，长期研究边缘计算框架 KubeEdge、调度框架 Volcano 等。公众号 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(239, 112, 96);">程序猿Damon</code> 发起人。个人微信 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(239, 112, 96);">MrNull008</code>，个人网站：<a class="nav-item-link" target="_blank" href="http://www.damon8.cn" style="text-decoration: none" title="">Damon | Micro-Service | Containerization | DevOps</a>，欢迎來撩。</em></p>
<br data-tool="mdnice编辑器">



<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">欢迎关注：<a class="nav-item-link" target="_blank" href="https://www.infoq.cn/profile/1905020/following/user" title="InfoQ">InfoQ</a></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">欢迎关注：<a class="nav-item-link" target="_blank" href="https://cloud.tencent.com/developer/column/invite/533b1afb" title="">腾讯自媒体专栏</a></p>

<br>

<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">欢迎关注</span><span class="suffix"></span></h2>

<p><img src="https://static001.geekbang.org/infoq/38/385163791aa296c4cc23be10afa5631d.jpeg" alt="公号：程序猿Damon"></p>
<p><img src="https://static001.geekbang.org/infoq/86/860561234baac42a49dac2ea24239882.jpeg" alt="公号：damon8"></p>
<p><img src="https://static001.geekbang.org/infoq/31/31b11ee840215b57487aa0269453e572.jpeg" alt="公号：天山六路折梅手"></p>
<br>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Unit one -->
<p><ins class="adsbygoogle"
     style="display:inline-block;text-align:center;width:880px;height:150px"
     data-ad-client="ca-pub-1354758384344627"
     data-ad-slot="8964778819"></ins></p>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script> 
      <!-- reward -->
      
      <div id="reward-btn">
        打赏
      </div>
      
    </div>
    


    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://www.damon8.cn/2021/05/06/micro-cloud-native/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/07/12/jupyter/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Jupyter Notebook 的使用
          
        </div>
      </a>
    
    
      <a href="/2021/03/30/ServiceMesh-01/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Service Mesh 是下一代微服务架构</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "",
    app_key: "",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2021
        <i class="ri-heart-fill heart_icon"></i> 码疯窝在香嗝喱辣
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered By <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Title - Nothing
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="http://www.beian.miit.gov.cn/" target="_black"></a>
        </li>
        
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1279099062&amp;web_id=1279099062'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href=""><img src="/images/logo/logo.png" alt="程序猿Damon"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/essay">专栏</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/course">课程</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/doc">文档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/os">开源</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>


    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat1.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->

<style type="text/css">
    #so360{white-space:nowrap}
    #so360_keyword{width:222
    #so360 form{margin:0;padding:0}px center;}
    #so360_submit{width:60outline:0;vertical-align:middle;padding-right: 95px;}
    #so360_keyword{background:url(https://p.ssl.qhimg.com/t01ab1a3fb05f0ee893.png)
    no-repeat 242
</style>

<div id="so360">
    <form action="http://www.so.com/s" target="_blank" id="so360form">
        <input type="text" autocomplete="off" name="q" id="so360_keyword">
        <input type="submit" id="so360_submit" value="搜 索">
        <input type="hidden" name="ie" value="utf8">
        <input type="hidden" name="src" value="zz_damon8.cn">
        <input type="hidden" name="site" value="damon8.cn">
        <input type="hidden" name="rg" value="0">
    </form>
</div>



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: '程序猿Damon'
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="86"
        src="//music.163.com/outchain/player?type=2&id=503838841&auto=1&height=66"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
  </div>

    <script>
        (function(){
            var src = "https://s.ssl.qhres2.com/ssl/ab77b6ea7f3fbf79.js";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

</body>


<!--<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center; width:700px; height:90px;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-1354758384344627"
     data-ad-slot="1051270406"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>-->


<!--<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center; width:700px; height:90px;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-1354758384344627"
     data-ad-slot="1051270406"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>-->

</html>